<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F5F3EF">
<meta name="apple-mobile-web-app-title" content="Lia's OS">
<link rel="manifest" href="manifest.json">
<link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
<link rel="apple-touch-icon" href="icon-192.png">
<title>Lia's OS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<!-- Supabase JS SDK (v2 browser bundle) -->
<script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<!-- localForage for offline IndexedDB cache -->
<script src="https://unpkg.com/localforage@1.10.0/dist/localforage.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        bg: '#F5F3EF',
        card: '#FFFFFF',
        border: '#E5DFD5',
        text: '#37352F',
        dim: '#9B9488',
        accent: '#7C5CFC',
        'accent-hover': '#6B4AE6',
      },
      fontFamily: {
        sans: ['DM Sans', 'Noto Sans KR', 'sans-serif'],
      }
    }
  }
}
</script>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { background: #F5F3EF; color: #37352F; font-family: 'DM Sans', 'Noto Sans KR', sans-serif; }
  ::-webkit-scrollbar { width: 6px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #D5CFC5; border-radius: 3px; }
  input, textarea, select { font-family: inherit; color: inherit; }
  .fade-in { animation: fadeIn 0.2s ease; }
  @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
  .progress-fill { transition: width 0.6s ease; }
  /* Rich editor styles */
  .rich-editor:empty:before { content: attr(data-placeholder); color: #9B9488; pointer-events: none; }
  .rich-editor h2 { font-size: 1.15rem; font-weight: 600; margin: 0.5em 0 0.25em; }
  .rich-editor h3 { font-size: 0.95rem; font-weight: 600; margin: 0.4em 0 0.2em; color: #7C7872; }
  .rich-editor p { margin: 0.2em 0; }
  .rich-editor ul, .rich-editor ol { padding-left: 1.5em; margin: 0.3em 0; }
  .rich-editor li { margin: 0.15em 0; }
  .rich-editor b, .rich-editor strong { color: #1A1A1A; }
  .rich-editor i, .rich-editor em { color: #7C5CFC; }
  .rich-editor s { color: #9B9488; text-decoration: line-through; }
  /* Card shadow for depth on light bg */
  .card-shadow { box-shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04); }
  /* Hide scrollbar for nav */
  nav::-webkit-scrollbar { display: none; }
  /* Safe area insets for notched phones */
  body { padding-top: env(safe-area-inset-top); padding-bottom: env(safe-area-inset-bottom); }
  /* Touch-friendly: minimum 44px tap targets on mobile */
  @media (max-width: 640px) {
    button, [role="button"] { min-height: 40px; }
    input, textarea, select { font-size: 16px !important; } /* Prevents iOS zoom on focus */
  }
  /* Login screen */
  .login-card { max-width: 380px; margin: 15vh auto; }
  /* Sync indicator */
  .sync-dot { width: 6px; height: 6px; border-radius: 50%; display: inline-block; }
  .sync-dot.online { background: #10B981; }
  .sync-dot.offline { background: #EF4444; }
  .sync-dot.syncing { background: #F59E0B; animation: pulse 1s infinite; }
  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
</style>
<script>
// Register service worker for PWA
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
  });
}
</script>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-type="module">
const { useState, useEffect, useCallback, useRef, createContext, useContext, useMemo } = React;

// ‚îÄ‚îÄ‚îÄ localStorage Hook ‚îÄ‚îÄ‚îÄ
function useLocalStorage(key, defaultValue) {
  const [value, setValue] = useState(() => {
    try {
      const stored = localStorage.getItem(key);
      return stored ? JSON.parse(stored) : defaultValue;
    } catch { return defaultValue; }
  });
  useEffect(() => {
    localStorage.setItem(key, JSON.stringify(value));
  }, [key, value]);
  return [value, setValue];
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ SUPABASE CONFIG ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚û°Ô∏è Replace these with your Supabase project values
const SUPABASE_URL      = 'TODO_MY_SUPABASE_URL';
const SUPABASE_ANON_KEY = 'TODO_MY_SUPABASE_ANON_KEY';

const sb = (typeof supabase !== 'undefined' && SUPABASE_URL !== 'TODO_MY_SUPABASE_URL')
  ? supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)
  : null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ AUTH CONTEXT ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const AuthContext = createContext({ user: null, loading: true });

function AuthProvider({ children }) {
  const [user, setUser]       = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!sb) { setLoading(false); return; }
    // Check current session
    sb.auth.getSession().then(({ data: { session } }) => {
      setUser(session?.user ?? null);
      setLoading(false);
    });
    // Listen for auth changes
    const { data: { subscription } } = sb.auth.onAuthStateChange((_event, session) => {
      setUser(session?.user ?? null);
    });
    return () => subscription.unsubscribe();
  }, []);

  return <AuthContext.Provider value={{ user, loading }}>{children}</AuthContext.Provider>;
}

function useAuth() { return useContext(AuthContext); }

// ‚îÄ‚îÄ‚îÄ Login Screen ‚îÄ‚îÄ‚îÄ
function LoginScreen() {
  const [email, setEmail]     = useState('');
  const [sent, setSent]       = useState(false);
  const [error, setError]     = useState('');
  const [busy, setBusy]       = useState(false);

  const handleSend = async () => {
    if (!email.trim()) return;
    setBusy(true); setError('');
    const { error: err } = await sb.auth.signInWithOtp({
      email: email.trim(),
      options: { emailRedirectTo: window.location.origin + window.location.pathname }
    });
    setBusy(false);
    if (err) setError(err.message);
    else setSent(true);
  };

  return (
    <div className="min-h-screen bg-bg flex items-start justify-center px-4">
      <div className="login-card w-full bg-card border border-border rounded-2xl p-8 text-center">
        <div className="w-14 h-14 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-accent to-purple-400 flex items-center justify-center text-2xl">üß†</div>
        <h1 className="text-xl font-bold mb-1">Lia's OS</h1>
        <p className="text-dim text-sm mb-6">Sign in to sync your data across devices</p>

        {sent ? (
          <div className="bg-green-50 border border-green-200 rounded-xl p-4 text-sm text-green-700">
            Check your email for a magic link! You can close this tab ‚Äî the link will bring you back.
          </div>
        ) : (
          <div className="space-y-3">
            <input type="email" value={email} onChange={e => setEmail(e.target.value)}
              onKeyDown={e => { if (e.key === 'Enter') handleSend(); }}
              placeholder="your@email.com"
              className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none focus:border-accent transition-colors" />
            <button onClick={handleSend} disabled={busy}
              className="w-full py-3 rounded-xl bg-accent hover:bg-accent-hover text-white font-medium text-sm transition-colors disabled:opacity-50">
              {busy ? 'Sending...' : 'Send magic link'}
            </button>
            {error && <p className="text-red-500 text-xs">{error}</p>}
          </div>
        )}

        <p className="text-dim text-xs mt-6">No password needed ‚Äî we'll email you a sign-in link.</p>
      </div>
    </div>
  );
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ OFFLINE CACHE (localForage / IndexedDB) ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const cache = (typeof localforage !== 'undefined') ? localforage.createInstance({ name: 'liaos' }) : null;

async function cacheSaveSettings(settings) {
  if (cache) await cache.setItem('settings', settings).catch(() => {});
}
async function cacheSaveData(data) {
  if (cache) await cache.setItem('data', data).catch(() => {});
}
async function cacheLoadSettings() {
  if (!cache) return null;
  return cache.getItem('settings').catch(() => null);
}
async function cacheLoadData() {
  if (!cache) return null;
  return cache.getItem('data').catch(() => null);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ SUPABASE SYNC LAYER ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Maps between the app's in-memory data model and the entries table.
// Array-based collections (dumps, tasks, etc.) are stored as individual rows.
// Settings & goals are stored in user_settings table.

// Which keys in the data object are arrays of items (each with .id)?
const ITEM_COLLECTIONS = [
  'dumps', 'tasks', 'events', 'contentPipeline',
  'references', 'learnings', 'fixedExpenses', 'expenses',
];
// Type name used in the DB entries.type column for each collection
const COLLECTION_TYPE_MAP = {
  dumps: 'dump', tasks: 'task', events: 'event',
  contentPipeline: 'content_pipeline', references: 'reference',
  learnings: 'learning', fixedExpenses: 'fixed_expense', expenses: 'expense',
};

// Flatten stickyNotes object ‚Üí array of entries with domain in payload
function flattenStickyNotes(stickyObj) {
  const arr = [];
  for (const [domain, notes] of Object.entries(stickyObj || {})) {
    for (const note of notes) {
      arr.push({ id: note.id, type: 'sticky_note', payload: { ...note, domain } });
    }
  }
  return arr;
}

// Rebuild stickyNotes object from flat entries
function unflattenStickyNotes(entries) {
  const obj = {};
  for (const e of entries) {
    const { domain, ...rest } = e.payload;
    if (!obj[domain]) obj[domain] = [];
    obj[domain].push(rest);
  }
  return obj;
}

// Convert full app data ‚Üí array of DB entry rows
function dataToEntries(userId, data) {
  const rows = [];
  for (const col of ITEM_COLLECTIONS) {
    const type = COLLECTION_TYPE_MAP[col];
    for (const item of (data[col] || [])) {
      rows.push({
        id: item.id,
        user_id: userId,
        type,
        payload: item,
        created_at: item.createdAt || item.date || new Date().toISOString(),
      });
    }
  }
  // Sticky notes
  rows.push(...flattenStickyNotes(data.stickyNotes).map(e => ({
    ...e, user_id: userId, created_at: e.payload.createdAt || new Date().toISOString(),
  })));
  return rows;
}

// Convert DB entry rows ‚Üí app data object
function entriesToData(entries, fallbackData) {
  const data = { ...fallbackData };
  // Clear collections that will be rebuilt from entries
  for (const col of ITEM_COLLECTIONS) data[col] = [];
  data.stickyNotes = {};

  const stickyEntries = [];
  for (const entry of entries) {
    // Reverse-map type ‚Üí collection name
    const col = Object.keys(COLLECTION_TYPE_MAP).find(k => COLLECTION_TYPE_MAP[k] === entry.type);
    if (col) {
      data[col].push(entry.payload);
    } else if (entry.type === 'sticky_note') {
      stickyEntries.push(entry);
    }
  }
  data.stickyNotes = unflattenStickyNotes(stickyEntries);
  return data;
}

// Supabase CRUD wrappers
async function loadEntries(userId) {
  if (!sb) return null;
  const { data, error } = await sb.from('entries')
    .select('*')
    .eq('user_id', userId)
    .order('updated_at', { ascending: false });
  if (error) { console.error('[sync] loadEntries error:', error); return null; }
  return data;
}

async function loadSettings(userId) {
  if (!sb) return null;
  const { data, error } = await sb.from('user_settings')
    .select('*')
    .eq('user_id', userId)
    .maybeSingle();
  if (error) { console.error('[sync] loadSettings error:', error); return null; }
  return data;
}

async function saveEntriesToSupabase(userId, appData) {
  if (!sb) return;
  const rows = dataToEntries(userId, appData);
  if (rows.length > 0) {
    // Upsert all current entries
    const { error } = await sb.from('entries')
      .upsert(rows, { onConflict: 'id' });
    if (error) console.error('[sync] saveEntries upsert error:', error);
  }
  // Clean up deleted entries: remove any DB rows not in current data
  const currentIds = rows.map(r => r.id);
  const { data: dbRows } = await sb.from('entries')
    .select('id')
    .eq('user_id', userId);
  if (dbRows) {
    const toDelete = dbRows.filter(r => !currentIds.includes(r.id)).map(r => r.id);
    if (toDelete.length > 0) {
      await sb.from('entries').delete().in('id', toDelete);
    }
  }
}

async function saveSettingsToSupabase(userId, settings, goals) {
  if (!sb) return;
  const { error } = await sb.from('user_settings')
    .upsert({
      user_id: userId,
      settings,
      goals,
    }, { onConflict: 'user_id' });
  if (error) console.error('[sync] saveSettings error:', error);
}

// ‚îÄ‚îÄ‚îÄ Sync status context ‚îÄ‚îÄ‚îÄ
const SyncContext = createContext({ status: 'idle', lastSync: null });
function useSync() { return useContext(SyncContext); }

// ‚îÄ‚îÄ‚îÄ ID Generator ‚îÄ‚îÄ‚îÄ
const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);

// ‚îÄ‚îÄ‚îÄ Date Helpers ‚îÄ‚îÄ‚îÄ
const toLocalISO = (d) => { const dt = new Date(d); return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`; };
const todayISO = () => toLocalISO(new Date());
const formatDate = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
const dayName = (d) => new Date(d).toLocaleDateString('en-US', { weekday: 'short' });
const dayNum = (d) => new Date(d).getDate();
const getMonthYear = () => new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

// ‚îÄ‚îÄ‚îÄ Default Data ‚îÄ‚îÄ‚îÄ
const DEFAULT_SETTINGS = {
  tags: [
    { id: 't1', label: 'üìã To-Do Now', color: '#EF4444' },
    { id: 't2', label: 'üìå To-Do Later', color: '#F97316' },
    { id: 't3', label: 'üí° Idea', color: '#EAB308' },
    { id: 't4', label: 'üê¶ Twitter', color: '#3B82F6' },
    { id: 't5', label: 'üéµ TikTok', color: '#EC4899' },
    { id: 't6', label: 'üìö Crypto', color: '#8B5CF6' },
    { id: 't7', label: 'üìà Marketing', color: '#22C55E' },
    { id: 't8', label: 'üß† Thought', color: '#6B7280' },
    { id: 't9', label: 'üèÉ Health', color: '#10B981' },
    { id: 't10', label: 'üìù Errand', color: '#92400E' },
    { id: 't11', label: 'üí∞ Finance', color: '#F97316' },
    { id: 't12', label: '‚ùì Unsorted', color: '#52525B' },
  ],
  areas: [
    { name: 'Crypto', color: '#8B5CF6', emoji: 'üìö' },
    { name: 'Content', color: '#EC4899', emoji: '‚ú®' },
    { name: 'AI', color: '#F59E0B', emoji: 'ü§ñ' },
    { name: 'Career', color: '#3B82F6', emoji: 'üíº' },
    { name: 'Health', color: '#10B981', emoji: 'üèÉ' },
    { name: 'Marketing', color: '#F97316', emoji: 'üìà' },
    { name: 'Errand', color: '#6B7280', emoji: 'üìù' },
    { name: 'Finance', color: '#A78BFA', emoji: 'üí∞' },
  ],
  progressAreas: ['Crypto', 'Content', 'AI'],
  progressTargets: { Crypto: 10, Content: 10, AI: 10 },
  learningDomains: ['Crypto', 'Marketing', 'AI & Tech', 'Books', 'Í≤ΩÏ†ú/ÏãúÏÇ¨', 'Personal Growth'],
  spendingCategories: ['Food', 'Transport', 'Coffee', 'Shopping', 'Tech', 'Health', 'Learning', 'Entertainment', 'Other'],
  goalMonth: 'March 2026',
  goalSections: [
    { name: 'Health', emoji: 'üèÉ', color: '#10B981' },
    { name: 'Career', emoji: 'üíº', color: '#3B82F6' },
    { name: 'Crypto', emoji: 'üìö', color: '#8B5CF6' },
    { name: 'Content', emoji: '‚ú®', color: '#EC4899' },
    { name: 'AI', emoji: 'ü§ñ', color: '#F59E0B' },
  ],
  // Web Clipper auto-classification rules
  // Each rule: if the URL or text contains the keyword, assign to that domain.
  // First match wins. Case-insensitive.
  clipRules: [
    { keyword: 'twitter.com', domain: 'Marketing' },
    { keyword: 'x.com', domain: 'Marketing' },
    { keyword: 'tiktok.com', domain: 'Marketing' },
    { keyword: 'crypto', domain: 'Crypto' },
    { keyword: 'bitcoin', domain: 'Crypto' },
    { keyword: 'ethereum', domain: 'Crypto' },
    { keyword: 'defi', domain: 'Crypto' },
    { keyword: 'web3', domain: 'Crypto' },
    { keyword: 'blockchain', domain: 'Crypto' },
    { keyword: 'openai', domain: 'AI & Tech' },
    { keyword: 'anthropic', domain: 'AI & Tech' },
    { keyword: 'chatgpt', domain: 'AI & Tech' },
    { keyword: 'claude', domain: 'AI & Tech' },
    { keyword: 'ai', domain: 'AI & Tech' },
    { keyword: 'marketing', domain: 'Marketing' },
    { keyword: 'growth', domain: 'Marketing' },
    { keyword: 'seo', domain: 'Marketing' },
    { keyword: 'health', domain: 'Personal Growth' },
    { keyword: 'economy', domain: 'Í≤ΩÏ†ú/ÏãúÏÇ¨' },
    { keyword: 'Í≤ΩÏ†ú', domain: 'Í≤ΩÏ†ú/ÏãúÏÇ¨' },
  ],
};

const DEFAULT_DATA = {
  events: [
    { id: uid(), title: 'Team sync call', date: todayISO(), time: '10:00', color: '#3B82F6' },
    { id: uid(), title: 'Yoga class', date: todayISO(), time: '18:00', color: '#10B981' },
  ],
  stickyNotes: {
    Crypto: [
      { id: uid(), text: 'Look into Arbitrum vs Optimism gas comparison', color: '#8B5CF6', createdAt: todayISO() },
      { id: uid(), text: 'DeFi = Decentralized Finance. No middlemen.', color: '#8B5CF6', createdAt: todayISO() },
    ],
    Marketing: [
      { id: uid(), text: 'Retargeting ads convert 70% better', color: '#F97316', createdAt: todayISO() },
    ],
  },
  dumps: [],
  tasks: [
    { id: uid(), title: 'Research gas fees on Ethereum', status: 'active', area: 'Crypto', priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Read Ch.4 of Read Write Own', status: 'active', area: 'Crypto', priority: 'When I Can', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Write Twitter thread about DeFi basics', status: 'active', area: 'Content', priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: "Film 'day in my life Bangkok' TikTok", status: 'parked', area: 'Content', priority: 'When I Can', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Apply to 3 Web3 marketing roles', status: 'active', area: 'Career', priority: 'Urgent', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Set up Claude Code MCP', status: 'parked', area: 'AI', priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Morning yoga routine', status: 'active', area: 'Health', priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
    { id: uid(), title: 'Pay Naver subscription', status: 'active', area: 'Errand', priority: 'Urgent', notes: '', learnings: '', doneDate: null, createdAt: todayISO() },
  ],
  goals: {
    Health: ['Exercise 4x/week', 'Fix ankle rehab routine', ''],
    Career: ['Land Web3 growth role', 'Follow up with Sherlock', ''],
    Crypto: ['Finish Read Write Own', 'Buy first crypto', ''],
    Content: ['Post 3 tweets/week', '1 TikTok/week', ''],
    AI: ['Build personal OS v1', ''],
  },
  contentPipeline: [
    { id: uid(), title: 'Why I moved to Bangkok for Web3', platform: 'TikTok', status: 'Raw Idea', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() },
    { id: uid(), title: 'DeFi explained in 60 seconds', platform: 'Twitter', status: 'In Production', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() },
    { id: uid(), title: 'My crypto learning journey', platform: 'Twitter', status: 'Published', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() },
  ],
  references: [
    { id: uid(), title: '@cryptowendy style', platform: 'Twitter', type: 'Influencer', link: '', notes: '', tags: [], color: '#3B82F6' },
    { id: uid(), title: 'Talking head + text overlay', platform: 'TikTok', type: 'Format Idea', link: '', notes: '', tags: [], color: '#EC4899' },
    { id: uid(), title: 'Thread ‚Üí carousel repurpose', platform: 'Both', type: 'Format Idea', link: '', notes: '', tags: [], color: '#8B5CF6' },
    { id: uid(), title: 'Lo-fi vlog aesthetic', platform: 'TikTok', type: 'Mood Board', link: '', notes: '', tags: [], color: '#EC4899' },
  ],
  learnings: [
    { id: uid(), title: 'Gas fees = transaction costs on Ethereum', domain: 'Crypto', source: 'Article', sourceName: 'Ethereum docs', takeaways: 'Gas fees are paid in ETH. They vary based on network congestion. Layer 2s reduce fees significantly.', contentPotential: true, fromTask: null, date: todayISO() },
    { id: uid(), title: 'GA4 event-based tracking model', domain: 'Marketing', source: 'Article', sourceName: 'Google Analytics Academy', takeaways: 'GA4 uses events instead of sessions. Every interaction is an event. Custom events need to be configured.', contentPotential: false, fromTask: null, date: todayISO() },
  ],
  fixedExpenses: [
    { id: uid(), name: 'Ïñ∏Îãà ÏÜ°Í∏à', amount: 200, currency: 'USD', type: 'Monthly' },
    { id: uid(), name: 'Naver Plus', amount: 4900, currency: 'KRW', type: 'Subscription' },
    { id: uid(), name: 'SKT', amount: 55000, currency: 'KRW', type: 'Subscription' },
    { id: uid(), name: 'Claude Pro', amount: 20, currency: 'USD', type: 'Subscription' },
    { id: uid(), name: 'ÎåÄÏ∂úÏù¥Ïûê', amount: 150000, currency: 'KRW', type: 'Monthly' },
  ],
  expenses: [
    { id: uid(), item: 'Pad Thai lunch', amount: 80, currency: 'THB', category: 'Food', date: todayISO() },
    { id: uid(), item: 'BTS to Siam', amount: 44, currency: 'THB', category: 'Transport', date: todayISO() },
    { id: uid(), item: 'Coffee at Roots', amount: 150, currency: 'THB', category: 'Coffee', date: todayISO() },
    { id: uid(), item: 'Yoga class', amount: 350, currency: 'THB', category: 'Health', date: todayISO() },
    { id: uid(), item: 'Grocery', amount: 520, currency: 'THB', category: 'Food', date: todayISO() },
    { id: uid(), item: 'Book: Tokenomics', amount: 450, currency: 'THB', category: 'Learning', date: todayISO() },
  ],
};

// ‚îÄ‚îÄ‚îÄ Data Context ‚îÄ‚îÄ‚îÄ
const DataContext = createContext();

function DataProvider({ children }) {
  const [settings, setSettings] = useLocalStorage('liaos_settings', DEFAULT_SETTINGS);
  const [data, setData] = useLocalStorage('liaos_data', DEFAULT_DATA);
  const [syncStatus, setSyncStatus] = useState('idle'); // 'idle' | 'syncing' | 'online' | 'offline'
  const [lastSync, setLastSync] = useState(null);
  const { user } = useAuth();
  const syncTimer = useRef(null);
  const dataRef = useRef(data);
  const settingsRef = useRef(settings);
  dataRef.current = data;
  settingsRef.current = settings;

  // ‚îÄ‚îÄ‚îÄ Debounced push to Supabase ‚îÄ‚îÄ‚îÄ
  const schedulePush = useCallback(() => {
    if (!user) return;
    if (syncTimer.current) clearTimeout(syncTimer.current);
    syncTimer.current = setTimeout(async () => {
      setSyncStatus('syncing');
      try {
        await Promise.all([
          saveEntriesToSupabase(user.id, dataRef.current),
          saveSettingsToSupabase(user.id, settingsRef.current, dataRef.current.goals),
        ]);
        // Also update IndexedDB cache
        await Promise.all([
          cacheSaveData(dataRef.current),
          cacheSaveSettings(settingsRef.current),
        ]);
        setSyncStatus('online');
        setLastSync(new Date());
      } catch (err) {
        console.error('[sync] push failed:', err);
        setSyncStatus('offline');
      }
    }, 1500); // 1.5s debounce
  }, [user]);

  // ‚îÄ‚îÄ‚îÄ Initial sync: load from cache, then Supabase ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    if (!user) return;
    let cancelled = false;

    (async () => {
      // Step 1: Load from IndexedDB cache (fast, local)
      const [cachedData, cachedSettings] = await Promise.all([
        cacheLoadData(), cacheLoadSettings(),
      ]);
      if (cancelled) return;
      if (cachedData)     setData(cachedData);
      if (cachedSettings) setSettings(cachedSettings);

      // Step 2: Load from Supabase (source of truth)
      if (!sb) { setSyncStatus('offline'); return; }
      setSyncStatus('syncing');
      try {
        const [entries, settingsRow] = await Promise.all([
          loadEntries(user.id),
          loadSettings(user.id),
        ]);
        if (cancelled) return;

        if (entries && entries.length > 0) {
          const rebuilt = entriesToData(entries, dataRef.current);
          // Preserve goals from user_settings if present
          if (settingsRow?.goals && Object.keys(settingsRow.goals).length > 0) {
            rebuilt.goals = settingsRow.goals;
          }
          setData(rebuilt);
          await cacheSaveData(rebuilt);
        }
        if (settingsRow?.settings && Object.keys(settingsRow.settings).length > 0) {
          setSettings(settingsRow.settings);
          await cacheSaveSettings(settingsRow.settings);
        }
        setSyncStatus('online');
        setLastSync(new Date());
      } catch (err) {
        console.error('[sync] initial pull failed:', err);
        setSyncStatus('offline');
      }
    })();

    return () => { cancelled = true; };
  }, [user]);

  // ‚îÄ‚îÄ‚îÄ Data & settings writers (trigger sync) ‚îÄ‚îÄ‚îÄ
  const updateData = useCallback((key, updater) => {
    setData(prev => {
      const next = { ...prev, [key]: typeof updater === 'function' ? updater(prev[key]) : updater };
      return next;
    });
    schedulePush();
  }, [setData, schedulePush]);

  const updateSettings = useCallback((key, value) => {
    setSettings(prev => ({ ...prev, [key]: value }));
    schedulePush();
  }, [setSettings, schedulePush]);

  // Expose setSettings/setData that also schedule push
  const setSettingsAndSync = useCallback((val) => {
    setSettings(val);
    schedulePush();
  }, [setSettings, schedulePush]);

  const setDataAndSync = useCallback((val) => {
    setData(val);
    schedulePush();
  }, [setData, schedulePush]);

  const getAreaColor = useCallback((areaName) => {
    const area = settings.areas.find(a => a.name === areaName);
    return area?.color || '#6B7280';
  }, [settings.areas]);

  const getAreaEmoji = useCallback((areaName) => {
    const area = settings.areas.find(a => a.name === areaName);
    return area?.emoji || 'üìã';
  }, [settings.areas]);

  const value = useMemo(() => ({
    settings, setSettings: setSettingsAndSync, updateSettings,
    data, setData: setDataAndSync, updateData,
    getAreaColor, getAreaEmoji,
  }), [settings, data]);

  return (
    <SyncContext.Provider value={{ status: syncStatus, lastSync }}>
      <DataContext.Provider value={value}>{children}</DataContext.Provider>
    </SyncContext.Provider>
  );
}

function useData() { return useContext(DataContext); }

// ‚îÄ‚îÄ‚îÄ Shared: complete task with learning cross-link ‚îÄ‚îÄ‚îÄ
function useCompleteTask() {
  const { data, updateData } = useData();
  return (taskId) => {
    const task = data.tasks.find(t => t.id === taskId);
    if (!task) return;
    updateData('tasks', prev => prev.map(t => t.id === taskId ? { ...t, status: 'done', doneDate: todayISO() } : t));
    // Auto-create learning entry if notes or learnings exist and area qualifies
    const learningAreas = ['Crypto', 'Content', 'AI', 'Marketing', 'Health', 'Career', 'Finance'];
    const memo = (task.learnings || '').trim() || (task.notes || '').trim();
    if (memo && learningAreas.includes(task.area)) {
      const domainMap = { Crypto: 'Crypto', Content: 'Marketing', AI: 'AI & Tech', Marketing: 'Marketing', Health: 'Personal Growth', Career: 'Personal Growth', Finance: 'Í≤ΩÏ†ú/ÏãúÏÇ¨' };
      const entry = {
        id: uid(), title: task.title, domain: domainMap[task.area] || task.area,
        source: 'Hands-on', sourceName: '', takeaways: task.learnings || task.notes,
        contentPotential: false, fromTask: task.title, date: todayISO(),
      };
      updateData('learnings', prev => [entry, ...prev]);
    }
  };
}

// ‚îÄ‚îÄ‚îÄ Reusable: EditableText ‚îÄ‚îÄ‚îÄ
function EditableText({ value, onChange, className = '', placeholder = 'Click to edit...', tag = 'span', multiline = false }) {
  const [editing, setEditing] = useState(false);
  const [draft, setDraft] = useState(value);
  const inputRef = useRef(null);

  useEffect(() => { setDraft(value); }, [value]);
  useEffect(() => { if (editing && inputRef.current) inputRef.current.focus(); }, [editing]);

  const save = () => {
    setEditing(false);
    if (draft !== value) onChange(draft);
  };

  if (editing) {
    if (multiline) {
      return <textarea ref={inputRef} value={draft} onChange={e => setDraft(e.target.value)} onBlur={save} onKeyDown={e => { if (e.key === 'Escape') { setDraft(value); setEditing(false); }}} className={`bg-transparent border border-accent/50 rounded px-2 py-1 outline-none text-text w-full resize-none ${className}`} rows={3} />;
    }
    return <input ref={inputRef} value={draft} onChange={e => setDraft(e.target.value)} onBlur={save} onKeyDown={e => { if (e.key === 'Enter') save(); if (e.key === 'Escape') { setDraft(value); setEditing(false); }}} className={`bg-transparent border border-accent/50 rounded px-2 py-1 outline-none text-text ${className}`} />;
  }

  return React.createElement(tag, {
    onClick: () => setEditing(true),
    className: `cursor-pointer hover:bg-black/5 rounded px-1 py-0.5 transition-colors ${!value ? 'text-dim italic' : ''} ${className}`,
  }, value || placeholder);
}

// ‚îÄ‚îÄ‚îÄ Reusable: Tag Pill ‚îÄ‚îÄ‚îÄ
function TagPill({ label, color, selected, onClick, small = false }) {
  return (
    <button
      onClick={onClick}
      className={`rounded-full border transition-all whitespace-nowrap ${small ? 'px-2 py-0.5 text-xs' : 'px-3 py-1.5 text-sm'} ${selected ? 'bg-opacity-20' : 'bg-transparent hover:bg-black/5'}`}
      style={{
        borderColor: selected ? color : '#E5DFD5',
        backgroundColor: selected ? color + '22' : 'transparent',
        color: selected ? color : '#9B9488',
      }}
    >
      {label}
    </button>
  );
}

// ‚îÄ‚îÄ‚îÄ Reusable: Modal ‚îÄ‚îÄ‚îÄ
function Modal({ open, onClose, title, children, wide = false }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-start justify-center pt-20 px-4" onClick={onClose}>
      <div className={`bg-card border border-border rounded-xl p-6 w-full ${wide ? 'max-w-2xl' : 'max-w-md'} max-h-[80vh] overflow-y-auto fade-in`} onClick={e => e.stopPropagation()}>
        <div className="flex items-center justify-between mb-4">
          <h3 className="text-lg font-semibold">{title}</h3>
          <button onClick={onClose} className="text-dim hover:text-text text-xl leading-none">&times;</button>
        </div>
        {children}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Settings Panel ‚îÄ‚îÄ‚îÄ
function SettingsPanel({ open, onClose, initialTab }) {
  const { settings, updateSettings } = useData();
  const [activeTab, setActiveTab] = useState(initialTab || 'tags');
  useEffect(() => { if (initialTab && open) setActiveTab(initialTab); }, [initialTab, open]);
  const [newTag, setNewTag] = useState('');
  const [newTagColor, setNewTagColor] = useState('#8B5CF6');
  const [newArea, setNewArea] = useState('');
  const [newAreaColor, setNewAreaColor] = useState('#8B5CF6');
  const [newAreaEmoji, setNewAreaEmoji] = useState('üìã');
  const [newDomain, setNewDomain] = useState('');
  const [newCategory, setNewCategory] = useState('');

  const [newRuleKeyword, setNewRuleKeyword] = useState('');
  const [newRuleDomain, setNewRuleDomain] = useState('');

  const tabs = [
    { key: 'tags', label: 'Tags' },
    { key: 'areas', label: 'Areas' },
    { key: 'domains', label: 'Domains' },
    { key: 'categories', label: 'Categories' },
    { key: 'progress', label: 'Progress' },
    { key: 'cliprules', label: 'üìé Clip Rules' },
  ];

  return (
    <Modal open={open} onClose={onClose} title="Settings" wide>
      <div className="flex gap-2 mb-4 flex-wrap">
        {tabs.map(t => (
          <button key={t.key} onClick={() => setActiveTab(t.key)}
            className={`px-3 py-1.5 rounded-lg text-sm transition-colors ${activeTab === t.key ? 'bg-accent text-white' : 'bg-black/5 text-dim hover:text-text'}`}>
            {t.label}
          </button>
        ))}
      </div>

      {activeTab === 'tags' && (
        <div className="space-y-2">
          {settings.tags.map((tag, i) => (
            <div key={tag.id} className="flex items-center gap-2 bg-black/5 rounded-lg px-3 py-2">
              <input type="color" value={tag.color} onChange={e => {
                const updated = [...settings.tags];
                updated[i] = { ...tag, color: e.target.value };
                updateSettings('tags', updated);
              }} className="w-6 h-6 rounded cursor-pointer bg-transparent border-0" />
              <EditableText value={tag.label} onChange={v => {
                const updated = [...settings.tags];
                updated[i] = { ...tag, label: v };
                updateSettings('tags', updated);
              }} className="flex-1" />
              <button onClick={() => updateSettings('tags', settings.tags.filter((_, j) => j !== i))}
                className="text-dim hover:text-red-400 text-sm">‚úï</button>
            </div>
          ))}
          <div className="flex gap-2 mt-3">
            <input type="color" value={newTagColor} onChange={e => setNewTagColor(e.target.value)} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
            <input value={newTag} onChange={e => setNewTag(e.target.value)} placeholder="New tag name..." className="flex-1 bg-black/5 border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
            <button onClick={() => { if (newTag.trim()) { updateSettings('tags', [...settings.tags, { id: uid(), label: newTag.trim(), color: newTagColor }]); setNewTag(''); }}}
              className="bg-accent hover:bg-accent-hover text-white px-3 py-1.5 rounded-lg text-sm">Add</button>
          </div>
        </div>
      )}

      {activeTab === 'areas' && (
        <div className="space-y-2">
          {settings.areas.map((area, i) => (
            <div key={i} className="flex items-center gap-2 bg-black/5 rounded-lg px-3 py-2">
              <input type="color" value={area.color} onChange={e => {
                const updated = [...settings.areas];
                updated[i] = { ...area, color: e.target.value };
                updateSettings('areas', updated);
              }} className="w-6 h-6 rounded cursor-pointer bg-transparent border-0" />
              <EditableText value={area.emoji} onChange={v => {
                const updated = [...settings.areas];
                updated[i] = { ...area, emoji: v };
                updateSettings('areas', updated);
              }} className="w-8 text-center" />
              <EditableText value={area.name} onChange={v => {
                const updated = [...settings.areas];
                updated[i] = { ...area, name: v };
                updateSettings('areas', updated);
              }} className="flex-1" />
              <button onClick={() => updateSettings('areas', settings.areas.filter((_, j) => j !== i))}
                className="text-dim hover:text-red-400 text-sm">‚úï</button>
            </div>
          ))}
          <div className="flex gap-2 mt-3">
            <input type="color" value={newAreaColor} onChange={e => setNewAreaColor(e.target.value)} className="w-8 h-8 rounded cursor-pointer bg-transparent border-0" />
            <input value={newAreaEmoji} onChange={e => setNewAreaEmoji(e.target.value)} className="w-10 bg-black/5 border border-border rounded-lg px-2 py-1.5 text-sm text-center text-text outline-none" />
            <input value={newArea} onChange={e => setNewArea(e.target.value)} placeholder="New area name..." className="flex-1 bg-black/5 border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
            <button onClick={() => { if (newArea.trim()) { updateSettings('areas', [...settings.areas, { name: newArea.trim(), color: newAreaColor, emoji: newAreaEmoji }]); setNewArea(''); }}}
              className="bg-accent hover:bg-accent-hover text-white px-3 py-1.5 rounded-lg text-sm">Add</button>
          </div>
        </div>
      )}

      {activeTab === 'domains' && (
        <div className="space-y-2">
          {settings.learningDomains.map((domain, i) => (
            <div key={i} className="flex items-center gap-2 bg-black/5 rounded-lg px-3 py-2">
              <EditableText value={domain} onChange={v => {
                const updated = [...settings.learningDomains];
                updated[i] = v;
                updateSettings('learningDomains', updated);
              }} className="flex-1" />
              <button onClick={() => updateSettings('learningDomains', settings.learningDomains.filter((_, j) => j !== i))}
                className="text-dim hover:text-red-400 text-sm">‚úï</button>
            </div>
          ))}
          <div className="flex gap-2 mt-3">
            <input value={newDomain} onChange={e => setNewDomain(e.target.value)} placeholder="New domain..." className="flex-1 bg-black/5 border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
            <button onClick={() => { if (newDomain.trim()) { updateSettings('learningDomains', [...settings.learningDomains, newDomain.trim()]); setNewDomain(''); }}}
              className="bg-accent hover:bg-accent-hover text-white px-3 py-1.5 rounded-lg text-sm">Add</button>
          </div>
        </div>
      )}

      {activeTab === 'categories' && (
        <div className="space-y-2">
          {settings.spendingCategories.map((cat, i) => (
            <div key={i} className="flex items-center gap-2 bg-black/5 rounded-lg px-3 py-2">
              <EditableText value={cat} onChange={v => {
                const updated = [...settings.spendingCategories];
                updated[i] = v;
                updateSettings('spendingCategories', updated);
              }} className="flex-1" />
              <button onClick={() => updateSettings('spendingCategories', settings.spendingCategories.filter((_, j) => j !== i))}
                className="text-dim hover:text-red-400 text-sm">‚úï</button>
            </div>
          ))}
          <div className="flex gap-2 mt-3">
            <input value={newCategory} onChange={e => setNewCategory(e.target.value)} placeholder="New category..." className="flex-1 bg-black/5 border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
            <button onClick={() => { if (newCategory.trim()) { updateSettings('spendingCategories', [...settings.spendingCategories, newCategory.trim()]); setNewCategory(''); }}}
              className="bg-accent hover:bg-accent-hover text-white px-3 py-1.5 rounded-lg text-sm">Add</button>
          </div>
        </div>
      )}

      {activeTab === 'progress' && (
        <div className="space-y-3">
          <p className="text-dim text-sm mb-2">Choose which areas show progress bars and set monthly targets.</p>
          {settings.areas.map((area) => {
            const isTracked = settings.progressAreas.includes(area.name);
            const target = settings.progressTargets[area.name] || 10;
            return (
              <div key={area.name} className="flex items-center gap-3 bg-black/5 rounded-lg px-3 py-2">
                <button onClick={() => {
                  if (isTracked) {
                    updateSettings('progressAreas', settings.progressAreas.filter(a => a !== area.name));
                  } else {
                    updateSettings('progressAreas', [...settings.progressAreas, area.name]);
                    if (!settings.progressTargets[area.name]) {
                      updateSettings('progressTargets', { ...settings.progressTargets, [area.name]: 10 });
                    }
                  }
                }} className={`w-5 h-5 rounded border-2 flex items-center justify-center text-xs ${isTracked ? 'border-accent bg-accent text-white' : 'border-border'}`}>
                  {isTracked && '‚úì'}
                </button>
                <span style={{ color: area.color }}>{area.emoji} {area.name}</span>
                {isTracked && (
                  <div className="flex items-center gap-1 ml-auto">
                    <span className="text-dim text-xs">Target:</span>
                    <input type="number" value={target} min={1} onChange={e => updateSettings('progressTargets', { ...settings.progressTargets, [area.name]: parseInt(e.target.value) || 1 })}
                      className="w-14 bg-black/5 border border-border rounded px-2 py-1 text-sm text-text text-center outline-none" />
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}

      {activeTab === 'cliprules' && (
        <div className="space-y-3">
          <p className="text-dim text-sm mb-2">
            When you share content to Lia's OS (via your phone's Share menu), it auto-classifies into a Learning domain using these rules. First keyword match wins.
          </p>

          {/* How to clip */}
          <div className="space-y-3">
            {/* Quick clip button */}
            <div className="bg-green-50 border border-green-200 rounded-xl p-4 space-y-2">
              <p className="text-sm font-semibold text-green-800">üìé Fastest way (any device)</p>
              <p className="text-xs text-green-700">Copy a URL or text anywhere ‚Üí open Lia's OS ‚Üí tap the <strong>üìé button</strong> in the header. Done.</p>
            </div>

            {/* iOS Shortcut */}
            <div className="bg-blue-50 border border-blue-200 rounded-xl p-4 space-y-2">
              <p className="text-sm font-semibold text-blue-800">iPhone: Add to Share Menu</p>
              <p className="text-xs text-blue-700">Create an iOS Shortcut so Lia's OS appears in your share sheet:</p>
              <ol className="text-xs text-blue-700 space-y-1 pl-4 list-decimal">
                <li>Open the <strong>Shortcuts</strong> app on your iPhone</li>
                <li>Tap <strong>+</strong> ‚Üí name it "Clip to Lia's OS"</li>
                <li>Tap <strong>"Receives"</strong> at the top ‚Üí turn on <strong>URLs</strong> and <strong>Text</strong></li>
                <li>Add action: <strong>"Open URLs"</strong></li>
                <li>Set the URL to:<br/>
                  <code className="text-[10px] bg-blue-100 px-1.5 py-0.5 rounded break-all block mt-1">
                    {window.location.origin + window.location.pathname}?url=[Shortcut Input]
                  </code>
                </li>
                <li>Tap <strong>Done</strong> ‚Üí it now appears in your Share Sheet!</li>
              </ol>
            </div>

            {/* Desktop bookmarklet */}
            <div className="bg-accent/10 border border-accent/20 rounded-xl p-4 space-y-2">
              <p className="text-sm font-semibold">Desktop: Bookmarklet</p>
              <p className="text-xs text-dim">Drag this to your bookmarks bar:</p>
              <a href={"javascript:void(window.open('" + window.location.origin + window.location.pathname + "?title='+encodeURIComponent(document.title)+'&url='+encodeURIComponent(location.href)+'&text='+encodeURIComponent(window.getSelection().toString()),'_self'))"}
                className="inline-block px-4 py-2.5 bg-accent text-white text-xs rounded-lg font-medium cursor-grab"
                onClick={e => e.preventDefault()}>
                üìé Clip to Lia's OS
              </a>
            </div>
          </div>

          {/* Rules list */}
          <div className="space-y-1.5">
            {(settings.clipRules || []).map((rule, i) => (
              <div key={i} className="flex items-center gap-2 bg-black/5 rounded-lg px-3 py-2">
                <span className="text-sm flex-1 font-mono text-text">{rule.keyword}</span>
                <span className="text-xs text-dim">‚Üí</span>
                <select value={rule.domain} onChange={e => {
                  const updated = [...settings.clipRules];
                  updated[i] = { ...updated[i], domain: e.target.value };
                  updateSettings('clipRules', updated);
                }} className="bg-bg border border-border rounded-lg px-2 py-1 text-xs text-text outline-none">
                  {settings.learningDomains.map(d => <option key={d} value={d}>{d}</option>)}
                </select>
                <button onClick={() => updateSettings('clipRules', settings.clipRules.filter((_, j) => j !== i))}
                  className="text-dim hover:text-red-400 text-sm w-8 h-8 flex items-center justify-center">‚úï</button>
              </div>
            ))}
          </div>

          {/* Add new rule */}
          <div className="flex gap-2 items-center flex-wrap">
            <input value={newRuleKeyword} onChange={e => setNewRuleKeyword(e.target.value)}
              placeholder="Keyword (e.g. 'solana')"
              className="flex-1 min-w-[120px] bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none" />
            <span className="text-xs text-dim">‚Üí</span>
            <select value={newRuleDomain || settings.learningDomains[0]} onChange={e => setNewRuleDomain(e.target.value)}
              className="bg-bg border border-border rounded-lg px-2 py-2 text-sm text-text outline-none">
              {settings.learningDomains.map(d => <option key={d} value={d}>{d}</option>)}
            </select>
            <button onClick={() => {
              if (!newRuleKeyword.trim()) return;
              updateSettings('clipRules', [...(settings.clipRules || []), { keyword: newRuleKeyword.trim(), domain: newRuleDomain || settings.learningDomains[0] }]);
              setNewRuleKeyword('');
            }} className="px-4 py-2 bg-accent hover:bg-accent-hover text-white rounded-lg text-sm">Add</button>
          </div>
        </div>
      )}
    </Modal>
  );
}

// ‚îÄ‚îÄ‚îÄ Data Export / Import ‚îÄ‚îÄ‚îÄ
function DataActions({ onOpenSettings }) {
  const { settings, data, setSettings, setData } = useData();
  const [showMenu, setShowMenu] = useState(false);

  const exportData = () => {
    const blob = new Blob([JSON.stringify({ settings, data }, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `liaos-backup-${todayISO()}.json`; a.click();
    URL.revokeObjectURL(url);
    setShowMenu(false);
  };

  const importData = () => {
    const input = document.createElement('input');
    input.type = 'file'; input.accept = '.json';
    input.onchange = (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (ev) => {
        try {
          const parsed = JSON.parse(ev.target.result);
          if (parsed.settings) setSettings(parsed.settings);
          if (parsed.data) setData(parsed.data);
          setShowMenu(false);
        } catch { alert('Invalid file'); }
      };
      reader.readAsText(file);
    };
    input.click();
  };

  return (
    <div className="relative">
      <button onClick={() => setShowMenu(!showMenu)}
        className="w-8 h-8 rounded-lg bg-black/5 hover:bg-black/10 flex items-center justify-center text-dim hover:text-text transition-colors" title="More">‚ãØ</button>
      {showMenu && (
        <div className="absolute right-0 top-10 bg-card border border-border rounded-xl py-1 w-44 z-40 shadow-xl fade-in">
          <button onClick={() => { onOpenSettings('tags'); setShowMenu(false); }} className="w-full text-left px-4 py-2 text-sm text-text hover:bg-black/5">‚öôÔ∏è Settings</button>
          <button onClick={exportData} className="w-full text-left px-4 py-2 text-sm text-text hover:bg-black/5">üì• Export data</button>
          <button onClick={importData} className="w-full text-left px-4 py-2 text-sm text-text hover:bg-black/5">üì§ Import data</button>
          <div className="border-t border-border my-1" />
          <button onClick={() => { if (confirm('This will reset ALL data to defaults. Are you sure?')) { localStorage.removeItem('liaos_settings'); localStorage.removeItem('liaos_data'); location.reload(); } }}
            className="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-black/5">üîÑ Reset to defaults</button>
          {sb && (
            <>
              <div className="border-t border-border my-1" />
              <button onClick={() => { sb.auth.signOut(); setShowMenu(false); }}
                className="w-full text-left px-4 py-2 text-sm text-dim hover:bg-black/5">üö™ Sign out</button>
            </>
          )}
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Sync Indicator ‚îÄ‚îÄ‚îÄ
function SyncIndicator() {
  const { status, lastSync } = useSync();
  const label = { idle: 'Local', syncing: 'Syncing...', online: 'Synced', offline: 'Offline' }[status] || '';
  const dotClass = status === 'syncing' ? 'syncing' : (status === 'online' ? 'online' : 'offline');
  return (
    <span className="flex items-center gap-1.5 text-[10px] text-dim" title={lastSync ? `Last sync: ${lastSync.toLocaleTimeString()}` : ''}>
      <span className={`sync-dot ${dotClass}`} />
      <span className="hidden sm:inline">{label}</span>
    </span>
  );
}

// ‚îÄ‚îÄ‚îÄ Header ‚îÄ‚îÄ‚îÄ
function Header({ onOpenSettings, onClipFromClipboard }) {
  const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
  return (
    <header className="flex items-center justify-between px-4 sm:px-6 py-3 sm:py-4 border-b border-border bg-card sticky top-0 z-30">
      <div className="flex items-center gap-2 sm:gap-3">
        <div className="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-gradient-to-br from-accent to-purple-400 flex items-center justify-center text-base sm:text-lg">üß†</div>
        <span className="text-lg sm:text-xl font-semibold tracking-tight">Lia's OS</span>
      </div>
      <div className="flex items-center gap-2 sm:gap-4">
        <SyncIndicator />
        <button onClick={onClipFromClipboard}
          className="w-8 h-8 sm:w-9 sm:h-9 rounded-lg bg-accent/10 hover:bg-accent/20 flex items-center justify-center text-sm transition-colors" title="Clip from clipboard">
          üìé
        </button>
        <span className="text-dim text-sm hidden md:block">{today}</span>
        <DataActions onOpenSettings={onOpenSettings} />
      </div>
    </header>
  );
}

// ‚îÄ‚îÄ‚îÄ Nav Bar ‚îÄ‚îÄ‚îÄ
function NavBar({ active, onChange }) {
  const boards = [
    { key: 'braindump', icon: 'üß†', label: 'Brain Dump' },
    { key: 'command', icon: 'üìä', label: 'Command' },
    { key: 'content', icon: '‚ú®', label: 'Content' },
    { key: 'learning', icon: 'üìö', label: 'Learning' },
    { key: 'finance', icon: 'üí∞', label: 'Finance' },
  ];
  return (
    <nav className="flex border-b border-border overflow-x-auto bg-card sticky top-[49px] sm:top-[57px] z-20" style={{ WebkitOverflowScrolling: 'touch', scrollbarWidth: 'none' }}>
      {boards.map(b => (
        <button key={b.key} onClick={() => onChange(b.key)}
          className={`flex-1 min-w-0 px-2 sm:px-5 py-3.5 text-xs sm:text-sm font-medium whitespace-nowrap transition-colors text-center ${active === b.key ? 'bg-white text-text border-b-2 border-accent' : 'text-dim hover:text-text hover:bg-black/5'}`}>
          <span className="sm:hidden text-base">{b.icon}</span>
          <span className="hidden sm:inline">{b.icon} {b.label}</span>
        </button>
      ))}
    </nav>
  );
}

// ‚îÄ‚îÄ‚îÄ Board 1: Brain Dump ‚îÄ‚îÄ‚îÄ

// ‚îÄ‚îÄ‚îÄ Full Monthly Calendar ‚îÄ‚îÄ‚îÄ
function MonthlyCalendar() {
  const { data, updateData } = useData();
  const [viewDate, setViewDate] = useState(new Date());
  const [selectedDate, setSelectedDate] = useState(null);
  const [addingEvent, setAddingEvent] = useState(false);
  const [newEvent, setNewEvent] = useState({ title: '', time: '', color: '#8B5CF6' });
  const [editingEvent, setEditingEvent] = useState(null);

  const year = viewDate.getFullYear();
  const month = viewDate.getMonth();
  const todayStr = todayISO();

  const monthLabel = viewDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
  const firstDay = new Date(year, month, 1).getDay(); // 0=Sun
  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const prevMonthDays = new Date(year, month, 0).getDate();

  const prevMonth = () => setViewDate(new Date(year, month - 1, 1));
  const nextMonth = () => setViewDate(new Date(year, month + 1, 1));
  const goToday = () => setViewDate(new Date());

  // Build calendar grid (6 rows x 7 cols)
  const cells = [];
  // Previous month trailing days
  for (let i = firstDay - 1; i >= 0; i--) {
    const day = prevMonthDays - i;
    const d = new Date(year, month - 1, day);
    cells.push({ date: d, iso: toLocalISO(d), inMonth: false, day });
  }
  // Current month
  for (let d = 1; d <= daysInMonth; d++) {
    const date = new Date(year, month, d);
    cells.push({ date, iso: toLocalISO(date), inMonth: true, day: d });
  }
  // Next month leading days
  const remaining = 42 - cells.length;
  for (let d = 1; d <= remaining; d++) {
    const date = new Date(year, month + 1, d);
    cells.push({ date, iso: toLocalISO(date), inMonth: false, day: d });
  }

  const getEventsForDate = (iso) => (data.events || []).filter(e => e.date === iso);

  const handleAddEvent = () => {
    if (!newEvent.title.trim() || !selectedDate) return;
    const event = { id: uid(), title: newEvent.title.trim(), date: selectedDate, time: newEvent.time || '', color: newEvent.color };
    updateData('events', prev => [...(prev || []), event]);
    setNewEvent({ title: '', time: '', color: '#8B5CF6' });
    setAddingEvent(false);
  };

  const handleDeleteEvent = (eventId) => {
    updateData('events', prev => (prev || []).filter(e => e.id !== eventId));
  };

  const handleUpdateEvent = (eventId, changes) => {
    updateData('events', prev => (prev || []).map(e => e.id === eventId ? { ...e, ...changes } : e));
    setEditingEvent(null);
  };

  const selectedEvents = selectedDate ? getEventsForDate(selectedDate) : [];
  const colorOptions = ['#8B5CF6', '#3B82F6', '#10B981', '#EC4899', '#F59E0B', '#EF4444', '#F97316'];

  return (
    <div className="bg-card border border-border rounded-xl p-4 mb-4">
      {/* Month header */}
      <div className="flex items-center justify-between mb-4">
        <button onClick={prevMonth} className="w-8 h-8 rounded-lg bg-black/5 hover:bg-black/10 flex items-center justify-center text-dim hover:text-text">&larr;</button>
        <div className="flex items-center gap-3">
          <h3 className="text-base font-semibold">{monthLabel}</h3>
          <button onClick={goToday} className="text-xs px-2 py-1 rounded bg-black/5 hover:bg-black/10 text-dim hover:text-text">Today</button>
        </div>
        <button onClick={nextMonth} className="w-8 h-8 rounded-lg bg-black/5 hover:bg-black/10 flex items-center justify-center text-dim hover:text-text">&rarr;</button>
      </div>

      {/* Day headers */}
      <div className="grid grid-cols-7 mb-1">
        {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(d => (
          <div key={d} className="text-center text-xs text-dim font-medium py-1">{d}</div>
        ))}
      </div>

      {/* Calendar grid */}
      <div className="grid grid-cols-7 gap-px">
        {cells.map((cell, i) => {
          const isToday = cell.iso === todayStr;
          const isSelected = cell.iso === selectedDate;
          const dayEvents = getEventsForDate(cell.iso);
          return (
            <button key={i} onClick={() => setSelectedDate(cell.iso === selectedDate ? null : cell.iso)}
              className={`relative p-1 min-h-[48px] rounded-lg text-left transition-all flex flex-col items-center
                ${cell.inMonth ? 'hover:bg-black/5' : 'opacity-30'}
                ${isSelected ? 'bg-accent/15 ring-1 ring-accent' : ''}
              `}>
              <span className={`text-xs font-medium w-6 h-6 flex items-center justify-center rounded-full
                ${isToday ? 'bg-accent text-white' : cell.inMonth ? 'text-text' : 'text-dim'}
              `}>{cell.day}</span>
              {dayEvents.length > 0 && (
                <div className="flex gap-0.5 mt-0.5">
                  {dayEvents.slice(0, 3).map(ev => (
                    <div key={ev.id} className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: ev.color }} />
                  ))}
                </div>
              )}
            </button>
          );
        })}
      </div>

      {/* Selected date panel */}
      {selectedDate && (
        <div className="mt-4 pt-4 border-t border-border fade-in">
          <div className="flex items-center justify-between mb-3">
            <h4 className="text-sm font-medium">
              {new Date(selectedDate + 'T12:00').toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' })}
            </h4>
            <button onClick={() => { setAddingEvent(true); setEditingEvent(null); }}
              className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add Event</button>
          </div>

          {/* Add event form */}
          {addingEvent && (
            <div className="bg-black/5 rounded-lg p-3 mb-3 space-y-3 fade-in">
              <input value={newEvent.title} onChange={e => setNewEvent(p => ({ ...p, title: e.target.value }))}
                placeholder="Event title..." className="w-full bg-transparent border border-border rounded-lg px-3 py-2.5 text-sm text-text outline-none focus:border-accent/50"
                onKeyDown={e => { if (e.key === 'Enter') handleAddEvent(); if (e.key === 'Escape') setAddingEvent(false); }}
                autoFocus />
              <input type="time" value={newEvent.time} onChange={e => setNewEvent(p => ({ ...p, time: e.target.value }))}
                className="w-full bg-transparent border border-border rounded-lg px-3 py-2.5 text-sm text-text outline-none" />
              <div className="flex flex-wrap gap-2 items-center">
                {colorOptions.map(c => (
                  <button key={c} onClick={() => setNewEvent(p => ({ ...p, color: c }))}
                    className={`w-7 h-7 rounded-full transition-transform ${newEvent.color === c ? 'scale-110 ring-2 ring-accent/40' : 'hover:scale-105'}`}
                    style={{ backgroundColor: c }} />
                ))}
              </div>
              <div className="flex gap-2 pt-1">
                <button onClick={() => setAddingEvent(false)} className="flex-1 py-2.5 rounded-lg text-sm text-dim hover:text-text bg-black/5 transition-colors">Cancel</button>
                <button onClick={handleAddEvent} className="flex-1 py-2.5 rounded-lg bg-accent hover:bg-accent-hover text-white text-sm font-medium transition-colors">Save</button>
              </div>
            </div>
          )}

          {/* Events list */}
          {selectedEvents.length === 0 && !addingEvent && (
            <p className="text-dim text-xs">No events. Click "+ Add Event" to create one.</p>
          )}
          {selectedEvents.sort((a, b) => (a.time || '').localeCompare(b.time || '')).map(ev => (
            <div key={ev.id} className="flex items-center gap-2 py-2 group">
              <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: ev.color }} />
              {editingEvent === ev.id ? (
                <div className="flex-1 flex gap-2 items-center">
                  <input defaultValue={ev.title} onBlur={e => handleUpdateEvent(ev.id, { title: e.target.value })}
                    onKeyDown={e => { if (e.key === 'Enter') handleUpdateEvent(ev.id, { title: e.target.value }); if (e.key === 'Escape') setEditingEvent(null); }}
                    className="flex-1 bg-transparent border border-accent/50 rounded px-2 py-0.5 text-sm text-text outline-none" autoFocus />
                  <input type="time" defaultValue={ev.time} onChange={e => handleUpdateEvent(ev.id, { time: e.target.value })}
                    className="bg-transparent border border-accent/50 rounded px-2 py-0.5 text-sm text-text outline-none w-24" />
                </div>
              ) : (
                <React.Fragment>
                  <span className="text-sm flex-1 cursor-pointer hover:bg-black/5 rounded px-1" onClick={() => setEditingEvent(ev.id)}>{ev.title}</span>
                  {ev.time && <span className="text-xs text-dim font-mono">{ev.time}</span>}
                </React.Fragment>
              )}
              <button onClick={() => handleDeleteEvent(ev.id)}
                className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function ActiveTasksPreview() {
  const { data, updateData, settings, getAreaColor } = useData();
  const completeTask = useCompleteTask();
  const activeTasks = data.tasks.filter(t => t.status === 'active');
  const [expandedTask, setExpandedTask] = useState(null);

  if (activeTasks.length === 0) return null;

  const updateTask = (taskId, changes) => {
    updateData('tasks', prev => prev.map(t => t.id === taskId ? { ...t, ...changes } : t));
  };
  const deleteTask = (taskId) => {
    updateData('tasks', prev => prev.filter(t => t.id !== taskId));
  };
  const parkTask = (taskId) => {
    updateData('tasks', prev => prev.map(t => t.id === taskId ? { ...t, status: 'parked' } : t));
  };

  return (
    <div className="bg-card border border-border rounded-xl p-4 mb-4">
      <div className="flex items-center justify-between mb-3">
        <h3 className="text-sm font-medium text-dim">‚ö° Active Tasks <span className="text-xs bg-black/10 px-1.5 py-0.5 rounded-full ml-1">{activeTasks.length}</span></h3>
      </div>
      <div className="space-y-1">
        {activeTasks.map(task => (
          <div key={task.id}>
            <div className="flex items-center gap-2 py-1.5 px-2 rounded-lg group hover:bg-black/5 transition-colors">
              <div className="w-2 h-2 rounded-full flex-shrink-0" style={{ backgroundColor: getAreaColor(task.area) }} />
              <span className="text-sm flex-1 truncate cursor-pointer hover:text-accent transition-colors" onClick={() => setExpandedTask(expandedTask === task.id ? null : task.id)}>
                {task.title}
              </span>
              <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-black/5" style={{ color: getAreaColor(task.area) }}>{task.area}</span>
              <button onClick={() => parkTask(task.id)} title="Park" className="text-dim hover:text-yellow-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">üïê</button>
              <button onClick={() => deleteTask(task.id)} title="Delete" className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
            </div>
            {expandedTask === task.id && (
              <div className="ml-4 mt-1 mb-2 p-3 bg-black/5 rounded-lg space-y-2 fade-in border border-border/50">
                <input value={task.title} onChange={e => updateTask(task.id, { title: e.target.value })}
                  className="w-full bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50" />
                <div className="flex gap-2">
                  <select value={task.area} onChange={e => updateTask(task.id, { area: e.target.value })}
                    className="flex-1 bg-card border border-border rounded-lg px-3 py-1.5 text-xs text-text outline-none">
                    {settings.areas.map(a => <option key={a.name} value={a.name}>{a.emoji} {a.name}</option>)}
                  </select>
                  <select value={task.priority} onChange={e => updateTask(task.id, { priority: e.target.value })}
                    className="flex-1 bg-card border border-border rounded-lg px-3 py-1.5 text-xs text-text outline-none">
                    <option value="Urgent">Urgent</option><option value="Important">Important</option><option value="When I Can">When I Can</option>
                  </select>
                </div>
                <textarea value={task.notes || ''} onChange={e => updateTask(task.id, { notes: e.target.value })}
                  className="w-full bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none resize-none focus:border-accent/50" rows={2} placeholder="Notes / what I did..." />
                <textarea value={task.learnings || ''} onChange={e => updateTask(task.id, { learnings: e.target.value })}
                  className="w-full bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none resize-none focus:border-accent/50" rows={2} placeholder="What I learned... (auto-saves to Learning Center)" />
                <button onClick={() => { completeTask(task.id); setExpandedTask(null); }}
                  className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                  ‚úì Done ‚Äî Save & Archive
                </button>
              </div>
            )}
          </div>
        ))}
      </div>
      <QuickAddTask />
    </div>
  );
}

function QuickAddTask() {
  const { updateData, settings } = useData();
  const [adding, setAdding] = useState(false);
  const [title, setTitle] = useState('');
  const [area, setArea] = useState(settings.areas[0]?.name || '');

  const handleAdd = () => {
    if (!title.trim()) return;
    const newTask = { id: uid(), title: title.trim(), status: 'active', area, priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() };
    updateData('tasks', prev => [newTask, ...prev]);
    setTitle('');
    setAdding(false);
  };

  if (!adding) {
    return (
      <button onClick={() => setAdding(true)} className="w-full mt-2 py-2 text-xs text-dim hover:text-accent border border-dashed border-border hover:border-accent/50 rounded-lg transition-colors">
        + Add task
      </button>
    );
  }

  return (
    <div className="mt-2 flex gap-2 fade-in">
      <input value={title} onChange={e => setTitle(e.target.value)} placeholder="New task..."
        className="flex-1 bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
        onKeyDown={e => { if (e.key === 'Enter') handleAdd(); if (e.key === 'Escape') setAdding(false); }} autoFocus />
      <select value={area} onChange={e => setArea(e.target.value)}
        className="bg-card border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none cursor-pointer">
        {settings.areas.map(a => <option key={a.name} value={a.name}>{a.emoji} {a.name}</option>)}
      </select>
      <button onClick={handleAdd} className="px-3 py-1.5 bg-accent hover:bg-accent-hover text-white rounded-lg text-xs">Add</button>
      <button onClick={() => setAdding(false)} className="px-2 py-1.5 text-dim hover:text-text text-xs">‚úï</button>
    </div>
  );
}

function BrainDump({ onOpenSettings }) {
  const { data, updateData, settings } = useData();
  const [input, setInput] = useState('');
  const [selectedTags, setSelectedTags] = useState([]);
  const inputRef = useRef(null);

  const toggleTag = (tagId) => {
    setSelectedTags(prev => prev.includes(tagId) ? prev.filter(t => t !== tagId) : [...prev, tagId]);
  };

  // Auto-classification hints
  const getClassificationHints = () => {
    const hints = [];
    const tagLabels = selectedTags.map(id => settings.tags.find(t => t.id === id)?.label || '');
    if (tagLabels.some(l => l.includes('To-Do Now'))) hints.push('‚Üí Will add to active TO-DO list');
    if (tagLabels.some(l => l.includes('To-Do Later'))) hints.push('‚Üí Will add to Parked list');
    const hasIdea = tagLabels.some(l => l.includes('Idea'));
    if (hasIdea && tagLabels.some(l => l.includes('Twitter'))) hints.push('‚Üí Will add to Content Pipeline (Twitter)');
    if (hasIdea && tagLabels.some(l => l.includes('TikTok'))) hints.push('‚Üí Will add to Content Pipeline (TikTok)');
    return hints;
  };

  // Determine area from tags
  const getAreaFromTags = (tagLabels) => {
    if (tagLabels.some(l => l.includes('Crypto'))) return 'Crypto';
    if (tagLabels.some(l => l.includes('Marketing'))) return 'Marketing';
    if (tagLabels.some(l => l.includes('Health'))) return 'Health';
    if (tagLabels.some(l => l.includes('Errand'))) return 'Errand';
    if (tagLabels.some(l => l.includes('Finance'))) return 'Finance';
    if (tagLabels.some(l => l.includes('Twitter') || l.includes('TikTok'))) return 'Content';
    return 'Unsorted';
  };

  const handleSubmit = () => {
    const text = input.trim();
    if (!text) return;

    const tagLabels = selectedTags.map(id => settings.tags.find(t => t.id === id)?.label || '');
    const area = getAreaFromTags(tagLabels);
    const dumpId = uid();

    // Create dump entry
    const newDump = { id: dumpId, text, tags: selectedTags, processed: true, createdAt: new Date().toISOString() };
    updateData('dumps', prev => [newDump, ...prev]);

    // Auto-create task if tagged To-Do
    if (tagLabels.some(l => l.includes('To-Do Now'))) {
      const newTask = { id: uid(), title: text, status: 'active', area, priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() };
      updateData('tasks', prev => [newTask, ...prev]);
    }
    if (tagLabels.some(l => l.includes('To-Do Later'))) {
      const newTask = { id: uid(), title: text, status: 'parked', area, priority: 'When I Can', notes: '', learnings: '', doneDate: null, createdAt: todayISO() };
      updateData('tasks', prev => [newTask, ...prev]);
    }

    // Auto-create content pipeline entry
    const hasIdea = tagLabels.some(l => l.includes('Idea'));
    if (hasIdea && tagLabels.some(l => l.includes('Twitter'))) {
      const entry = { id: uid(), title: text, platform: 'Twitter', status: 'Raw Idea', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() };
      updateData('contentPipeline', prev => [entry, ...prev]);
    }
    if (hasIdea && tagLabels.some(l => l.includes('TikTok'))) {
      const entry = { id: uid(), title: text, platform: 'TikTok', status: 'Raw Idea', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() };
      updateData('contentPipeline', prev => [entry, ...prev]);
    }

    setInput('');
    setSelectedTags([]);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSubmit();
    }
  };

  const deleteDump = (id) => {
    updateData('dumps', prev => prev.filter(d => d.id !== id));
  };

  const hints = getClassificationHints();

  return (
    <div className="max-w-3xl mx-auto px-4 py-6">
      <MonthlyCalendar />
      <ActiveTasksPreview />

      {/* Dump Input */}
      <div className="bg-card border border-border rounded-xl p-4 mb-4">
        <div className="flex gap-3">
          <textarea
            ref={inputRef}
            value={input}
            onChange={e => setInput(e.target.value)}
            onKeyDown={handleKeyDown}
            placeholder="What's on your mind? Dump it here..."
            className="flex-1 bg-transparent text-text placeholder-dim outline-none resize-none text-base"
            rows={2}
          />
          <button onClick={handleSubmit}
            className="self-end w-10 h-10 rounded-xl bg-accent hover:bg-accent-hover text-white flex items-center justify-center text-xl font-bold transition-colors flex-shrink-0">
            +
          </button>
        </div>

        {/* Tag Selector */}
        <div className="mt-3 pt-3 border-t border-border">
          <div className="flex items-center gap-2 mb-2">
            <span className="text-xs text-dim">Tags:</span>
            <button onClick={() => onOpenSettings('tags')} className="text-xs text-dim hover:text-accent transition-colors">‚öôÔ∏è edit</button>
          </div>
          <div className="flex flex-wrap gap-1.5">
            {settings.tags.map(tag => (
              <TagPill
                key={tag.id}
                label={tag.label}
                color={tag.color}
                selected={selectedTags.includes(tag.id)}
                onClick={() => toggleTag(tag.id)}
                small
              />
            ))}
          </div>
        </div>

        {/* Classification hints */}
        {hints.length > 0 && (
          <div className="mt-2 space-y-0.5">
            {hints.map((h, i) => (
              <p key={i} className="text-xs text-accent">{h}</p>
            ))}
          </div>
        )}
      </div>

      {/* Recent Dumps */}
      <div>
        <h3 className="text-sm font-medium text-dim mb-3">Recent Dumps</h3>
        {data.dumps.length === 0 ? (
          <div className="bg-card border border-border border-dashed rounded-xl p-6 text-center text-dim text-sm">
            No dumps yet. Type something above and hit + to start.
          </div>
        ) : (
          <div className="space-y-2">
            {data.dumps.slice(0, 20).map(dump => (
              <div key={dump.id} className="bg-card border border-border rounded-xl p-3 flex items-start gap-3 group fade-in">
                <button onClick={() => deleteDump(dump.id)}
                  className="mt-0.5 w-5 h-5 rounded border border-border text-dim hover:border-red-400 hover:text-red-400 flex items-center justify-center text-xs flex-shrink-0 opacity-0 group-hover:opacity-100 transition-opacity">
                  ‚úï
                </button>
                <div className="flex-1 min-w-0">
                  <p className="text-sm">{dump.text}</p>
                  <div className="flex flex-wrap gap-1 mt-1.5">
                    {dump.tags.map(tagId => {
                      const tag = settings.tags.find(t => t.id === tagId);
                      if (!tag) return null;
                      return <span key={tagId} className="text-xs px-2 py-0.5 rounded-full border" style={{ borderColor: tag.color + '66', color: tag.color }}>{tag.label}</span>;
                    })}
                  </div>
                </div>
                <span className="text-xs text-dim flex-shrink-0 mt-0.5">
                  {new Date(dump.createdAt).toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}
                </span>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Board 2: Command Center ‚îÄ‚îÄ‚îÄ
function CommandCenter() {
  const { data, updateData, settings, getAreaColor, getAreaEmoji } = useData();
  const [expandedTask, setExpandedTask] = useState(null);
  const [showDone, setShowDone] = useState(false);
  const [addingTask, setAddingTask] = useState(false);
  const [newTaskTitle, setNewTaskTitle] = useState('');
  const [newTaskArea, setNewTaskArea] = useState(settings.areas[0]?.name || '');

  const activeTasks = data.tasks.filter(t => t.status === 'active');
  const parkedTasks = data.tasks.filter(t => t.status === 'parked');
  const doneTasks = data.tasks.filter(t => t.status === 'done');

  const updateTask = (taskId, changes) => {
    updateData('tasks', prev => prev.map(t => t.id === taskId ? { ...t, ...changes } : t));
  };

  const deleteTask = (taskId) => {
    updateData('tasks', prev => prev.filter(t => t.id !== taskId));
  };

  const completeTask = useCompleteTask();

  const restoreTask = (taskId) => {
    updateTask(taskId, { status: 'active', doneDate: null });
  };

  const activateTask = (taskId) => {
    updateTask(taskId, { status: 'active' });
  };

  const parkTask = (taskId) => {
    updateTask(taskId, { status: 'parked' });
  };

  const handleAddTask = () => {
    if (!newTaskTitle.trim()) return;
    const t = { id: uid(), title: newTaskTitle.trim(), status: 'active', area: newTaskArea, priority: 'Important', notes: '', learnings: '', doneDate: null, createdAt: todayISO() };
    updateData('tasks', prev => [t, ...prev]);
    setNewTaskTitle('');
    setAddingTask(false);
  };

  // Progress bars
  const now = new Date();
  const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

  return (
    <div className="max-w-5xl mx-auto px-4 py-6 space-y-6">
      {/* ‚îÄ‚îÄ Section 1: Tasks ‚îÄ‚îÄ */}
      <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
        {/* Active Tasks (3/5 width) */}
        <div className="lg:col-span-3 bg-card border border-border rounded-xl p-4">
          <div className="flex items-center justify-between mb-3">
            <h3 className="font-semibold flex items-center gap-2">‚ö° Active Tasks <span className="text-xs bg-accent/20 text-accent px-2 py-0.5 rounded-full">{activeTasks.length}</span></h3>
            <button onClick={() => setAddingTask(!addingTask)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add</button>
          </div>

          {addingTask && (
            <div className="flex gap-2 mb-3 fade-in">
              <input value={newTaskTitle} onChange={e => setNewTaskTitle(e.target.value)} placeholder="Task title..."
                className="flex-1 bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
                onKeyDown={e => { if (e.key === 'Enter') handleAddTask(); if (e.key === 'Escape') setAddingTask(false); }} autoFocus />
              <select value={newTaskArea} onChange={e => setNewTaskArea(e.target.value)} className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
                {settings.areas.map(a => <option key={a.name} value={a.name}>{a.emoji} {a.name}</option>)}
              </select>
              <button onClick={handleAddTask} className="px-3 py-1.5 bg-accent text-white rounded-lg text-xs">Add</button>
            </div>
          )}

          {activeTasks.length === 0 && <p className="text-dim text-sm py-4 text-center">No active tasks. Add one or dump something tagged "To-Do Now".</p>}

          <div className="space-y-0.5">
            {activeTasks.map(task => (
              <div key={task.id}>
                <div className="flex items-center gap-2 py-2 px-2 rounded-lg group hover:bg-black/5 transition-colors">
                  <div className="w-2.5 h-2.5 rounded-full flex-shrink-0" style={{ backgroundColor: getAreaColor(task.area) }} />
                  <span className="text-sm flex-1 cursor-pointer hover:text-accent transition-colors" onClick={() => setExpandedTask(expandedTask === task.id ? null : task.id)}>
                    {task.title}
                  </span>
                  <span className="text-xs px-2 py-0.5 rounded-full border" style={{ color: getAreaColor(task.area), borderColor: getAreaColor(task.area) + '44' }}>{task.area}</span>
                  <button onClick={() => parkTask(task.id)} title="Park" className="text-dim hover:text-yellow-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">üïê</button>
                  <button onClick={() => deleteTask(task.id)} title="Delete" className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
                </div>

                {expandedTask === task.id && (
                  <div className="ml-5 mb-2 p-4 bg-black/5 rounded-lg space-y-3 fade-in border border-border/50">
                    <input value={task.title} onChange={e => updateTask(task.id, { title: e.target.value })}
                      className="w-full bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50 font-medium" />
                    <div className="grid grid-cols-2 gap-2">
                      <select value={task.area} onChange={e => updateTask(task.id, { area: e.target.value })}
                        className="bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none">
                        {settings.areas.map(a => <option key={a.name} value={a.name}>{a.emoji} {a.name}</option>)}
                      </select>
                      <select value={task.priority} onChange={e => updateTask(task.id, { priority: e.target.value })}
                        className="bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none">
                        <option value="Urgent">Urgent</option><option value="Important">Important</option><option value="When I Can">When I Can</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-xs text-dim block mb-1">üìù Notes / What I did</label>
                      <textarea value={task.notes || ''} onChange={e => updateTask(task.id, { notes: e.target.value })}
                        className="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-text outline-none resize-none focus:border-accent/50" rows={2} placeholder="What did you do?" />
                    </div>
                    <div>
                      <label className="text-xs text-dim block mb-1">üí° What I learned <span className="text-accent/60">(auto-saves to Learning Center)</span></label>
                      <textarea value={task.learnings || ''} onChange={e => updateTask(task.id, { learnings: e.target.value })}
                        className="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-text outline-none resize-none focus:border-accent/50" rows={2} placeholder="Key takeaways..." />
                    </div>
                    <button onClick={() => { completeTask(task.id); setExpandedTask(null); }}
                      className="w-full py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-medium transition-colors">
                      ‚úì Done ‚Äî Save & Archive
                    </button>
                  </div>
                )}
              </div>
            ))}
          </div>
        </div>

        {/* Parked Tasks (2/5 width) */}
        <div className="lg:col-span-2 bg-card border border-border rounded-xl p-4">
          <h3 className="font-semibold flex items-center gap-2 mb-3 text-dim">üïê Parked <span className="text-xs bg-black/10 px-2 py-0.5 rounded-full">{parkedTasks.length}</span></h3>
          {parkedTasks.length === 0 && <p className="text-dim text-xs py-4 text-center">No parked tasks.</p>}
          <div className="space-y-1">
            {parkedTasks.map(task => (
              <div key={task.id} className="flex items-center gap-2 py-2 px-2 rounded-lg group hover:bg-black/5 transition-colors opacity-70 hover:opacity-100">
                <button onClick={() => activateTask(task.id)} title="Activate"
                  className="text-xs text-dim hover:text-accent transition-colors">‚ñ∂</button>
                <EditableText value={task.title} onChange={v => updateTask(task.id, { title: v })} className="text-sm flex-1" />
                <span className="text-[10px] px-1.5 py-0.5 rounded bg-black/5" style={{ color: getAreaColor(task.area) }}>{task.area}</span>
                <button onClick={() => deleteTask(task.id)} className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
              </div>
            ))}
          </div>
          <p className="text-[10px] text-dim mt-3 text-center">Click ‚ñ∂ to activate a task</p>
        </div>
      </div>

      {/* Done section */}
      <div className="bg-card border border-border rounded-xl p-4">
        <button onClick={() => setShowDone(!showDone)} className="flex items-center gap-2 w-full text-left">
          <span className="text-sm">{showDone ? '‚ñº' : '‚ñ∂'}</span>
          <h3 className="font-semibold text-dim flex items-center gap-2">‚úÖ Done <span className="text-xs bg-black/10 px-2 py-0.5 rounded-full">{doneTasks.length}</span></h3>
        </button>
        {showDone && (
          <div className="mt-3 space-y-1 fade-in">
            {doneTasks.length === 0 && <p className="text-dim text-xs text-center py-2">No completed tasks yet.</p>}
            {doneTasks.map(task => (
              <div key={task.id} className="flex items-center gap-2 py-1.5 px-2 rounded-lg group hover:bg-black/5">
                <span className="text-green-400 text-xs">‚úì</span>
                <span className="text-sm text-dim line-through flex-1">{task.title}</span>
                {task.learnings && <span className="text-xs text-accent" title="Has learning notes">üìñ</span>}
                <span className="text-[10px] text-dim">{task.doneDate}</span>
                <button onClick={() => restoreTask(task.id)} title="Restore to active"
                  className="text-xs text-dim hover:text-accent opacity-0 group-hover:opacity-100 transition-opacity">‚Ü© undo</button>
              </div>
            ))}
          </div>
        )}
      </div>

      {/* ‚îÄ‚îÄ Section 2: Monthly Goals ‚îÄ‚îÄ */}
      <MonthlyGoals />

      {/* ‚îÄ‚îÄ Section 3: Progress Bars ‚îÄ‚îÄ */}
      <ProgressBars />
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Monthly Goals ‚îÄ‚îÄ‚îÄ
function MonthlyGoals() {
  const { data, updateData, settings, updateSettings, getAreaColor } = useData();

  const updateGoal = (section, index, value) => {
    updateData('goals', prev => {
      const updated = { ...prev };
      const list = [...(updated[section] || [])];
      list[index] = value;
      // Auto-add empty row if last one has text
      if (index === list.length - 1 && value.trim()) list.push('');
      updated[section] = list;
      return updated;
    });
  };

  const deleteGoal = (section, index) => {
    updateData('goals', prev => {
      const updated = { ...prev };
      const list = [...(updated[section] || [])];
      list.splice(index, 1);
      if (list.length === 0 || list[list.length - 1] !== '') list.push('');
      updated[section] = list;
      return updated;
    });
  };

  const addSection = () => {
    const name = prompt('New goal section name:');
    if (!name || !name.trim()) return;
    updateSettings('goalSections', [...settings.goalSections, { name: name.trim(), emoji: 'üéØ', color: '#8B5CF6' }]);
    updateData('goals', prev => ({ ...prev, [name.trim()]: [''] }));
  };

  const deleteSection = (sectionName) => {
    updateSettings('goalSections', settings.goalSections.filter(s => s.name !== sectionName));
    updateData('goals', prev => {
      const updated = { ...prev };
      delete updated[sectionName];
      return updated;
    });
  };

  const updateSectionName = (index, newName) => {
    const oldName = settings.goalSections[index].name;
    const updated = [...settings.goalSections];
    updated[index] = { ...updated[index], name: newName };
    updateSettings('goalSections', updated);
    // Move goals data to new key
    updateData('goals', prev => {
      const g = { ...prev };
      g[newName] = g[oldName] || [''];
      if (newName !== oldName) delete g[oldName];
      return g;
    });
  };

  return (
    <div className="bg-card border border-border rounded-xl p-4">
      <div className="flex items-center justify-between mb-4">
        <h3 className="font-semibold flex items-center gap-2">
          üéØ <EditableText value={settings.goalMonth} onChange={v => updateSettings('goalMonth', v)} className="inline" /> Goals
        </h3>
        <button onClick={addSection} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add Section</button>
      </div>

      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
        {settings.goalSections.map((section, si) => {
          const goals = data.goals[section.name] || [''];
          return (
            <div key={si} className="bg-black/5 rounded-xl p-3 border border-border/50">
              <div className="flex items-center justify-between mb-2">
                <div className="flex items-center gap-1.5">
                  <EditableText value={section.emoji} onChange={v => {
                    const updated = [...settings.goalSections]; updated[si] = { ...section, emoji: v }; updateSettings('goalSections', updated);
                  }} className="text-base" />
                  <EditableText value={section.name} onChange={v => updateSectionName(si, v)}
                    className="text-sm font-medium" />
                </div>
                <button onClick={() => deleteSection(section.name)} className="text-dim hover:text-red-400 text-xs">‚úï</button>
              </div>
              <div className="space-y-1">
                {goals.map((goal, gi) => (
                  <div key={gi} className="flex items-center gap-1 group">
                    <div className="w-1.5 h-1.5 rounded-full flex-shrink-0" style={{ backgroundColor: section.color || '#8B5CF6' }} />
                    <input value={goal} onChange={e => updateGoal(section.name, gi, e.target.value)}
                      placeholder={gi === goals.length - 1 ? 'Add goal...' : ''}
                      className="flex-1 bg-transparent text-sm text-text outline-none placeholder-dim/40 py-0.5" />
                    {goal && (
                      <button onClick={() => deleteGoal(section.name, gi)}
                        className="text-dim hover:text-red-400 text-[10px] opacity-0 group-hover:opacity-100">‚úï</button>
                    )}
                  </div>
                ))}
              </div>
            </div>
          );
        })}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Progress Bars ‚îÄ‚îÄ‚îÄ
function ProgressBars() {
  const { data, settings, updateSettings, getAreaColor, getAreaEmoji } = useData();

  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

  return (
    <div className="bg-card border border-border rounded-xl p-4">
      <h3 className="font-semibold mb-4">üìà Monthly Progress</h3>
      <div className="space-y-4">
        {settings.progressAreas.map(area => {
          const target = settings.progressTargets[area] || 10;
          const completed = data.tasks.filter(t => t.status === 'done' && t.area === area && (t.doneDate || '').startsWith(currentMonth)).length;
          const pct = Math.min((completed / target) * 100, 100);
          return (
            <div key={area} className="space-y-1">
              <div className="flex items-center justify-between">
                <span className="text-sm" style={{ color: getAreaColor(area) }}>{getAreaEmoji(area)} {area}</span>
                <div className="flex items-center gap-2">
                  <span className="text-xs text-dim font-mono">{completed} /</span>
                  <input type="number" value={target} min={1}
                    onChange={e => updateSettings('progressTargets', { ...settings.progressTargets, [area]: parseInt(e.target.value) || 1 })}
                    className="w-10 bg-transparent border-b border-border text-xs text-dim text-center outline-none focus:border-accent" />
                </div>
              </div>
              <div className="w-full h-2.5 bg-black/5 rounded-full overflow-hidden">
                <div className="h-full rounded-full progress-fill" style={{ width: pct + '%', backgroundColor: getAreaColor(area) }} />
              </div>
            </div>
          );
        })}
      </div>
      <p className="text-[10px] text-dim mt-4 text-center">Complete tasks and mark them done ‚Äî progress updates automatically.</p>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Board 3: Content Hub ‚îÄ‚îÄ‚îÄ
const PIPELINE_STAGES = [
  { key: 'Raw Idea', label: 'üí≠ Raw Idea' },
  { key: 'In Production', label: 'üé¨ In Production' },
  { key: 'Published', label: '‚úÖ Published' },
];

const PLATFORM_COLORS = { Twitter: '#3B82F6', TikTok: '#EC4899', Both: '#8B5CF6', YouTube: '#EF4444', Instagram: '#F97316' };

function ContentHub() {
  const { data, updateData } = useData();
  const [editingCard, setEditingCard] = useState(null);
  const [addingIdea, setAddingIdea] = useState(false);
  const [newIdea, setNewIdea] = useState({ title: '', platform: 'Twitter' });
  const [editingRef, setEditingRef] = useState(null);
  const [addingRef, setAddingRef] = useState(false);
  const [newRef, setNewRef] = useState({ title: '', platform: 'Twitter', type: 'Influencer' });

  // Content potential suggestions from Learning Center
  const suggestions = (data.learnings || []).filter(l => l.contentPotential);

  const updatePipelineItem = (id, changes) => {
    updateData('contentPipeline', prev => prev.map(c => c.id === id ? { ...c, ...changes } : c));
  };
  const deletePipelineItem = (id) => {
    updateData('contentPipeline', prev => prev.filter(c => c.id !== id));
    setEditingCard(null);
  };
  const addPipelineItem = () => {
    if (!newIdea.title.trim()) return;
    const item = { id: uid(), title: newIdea.title.trim(), platform: newIdea.platform, status: 'Raw Idea', hook: '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() };
    updateData('contentPipeline', prev => [item, ...prev]);
    setNewIdea({ title: '', platform: 'Twitter' });
    setAddingIdea(false);
  };
  const createFromSuggestion = (learning) => {
    const item = { id: uid(), title: learning.title, platform: 'Twitter', status: 'Raw Idea', hook: learning.takeaways?.slice(0, 100) || '', script: '', publishDate: '', performanceNotes: '', createdAt: todayISO() };
    updateData('contentPipeline', prev => [item, ...prev]);
  };

  const updateRef = (id, changes) => {
    updateData('references', prev => prev.map(r => r.id === id ? { ...r, ...changes } : r));
  };
  const deleteRef = (id) => {
    updateData('references', prev => prev.filter(r => r.id !== id));
    setEditingRef(null);
  };
  const addRef = () => {
    if (!newRef.title.trim()) return;
    const r = { id: uid(), title: newRef.title.trim(), platform: newRef.platform, type: newRef.type, link: '', notes: '', tags: [], color: PLATFORM_COLORS[newRef.platform] || '#8B5CF6' };
    updateData('references', prev => [...prev, r]);
    setNewRef({ title: '', platform: 'Twitter', type: 'Influencer' });
    setAddingRef(false);
  };

  const editCard = editingCard ? data.contentPipeline.find(c => c.id === editingCard) : null;
  const editRefCard = editingRef ? data.references.find(r => r.id === editingRef) : null;

  // Weekly calendar ‚Äî show content due this week
  const getWeekDays = () => {
    const today = new Date();
    const dayOfWeek = today.getDay();
    const monday = new Date(today);
    monday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    const days = [];
    for (let i = 0; i < 7; i++) {
      const d = new Date(monday);
      d.setDate(monday.getDate() + i);
      days.push(d);
    }
    return days;
  };
  const weekDays = getWeekDays();
  const todayStr = todayISO();

  const getContentForDate = (iso) => data.contentPipeline.filter(c => c.publishDate === iso);

  return (
    <div className="max-w-6xl mx-auto px-4 py-6 space-y-6">
      {/* ‚îÄ‚îÄ Weekly Content Calendar ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <h3 className="font-semibold mb-3">üìÖ This Week's Content</h3>
        <div className="grid grid-cols-7 gap-2">
          {weekDays.map(d => {
            const iso = toLocalISO(d);
            const isToday = iso === todayStr;
            const items = getContentForDate(iso);
            return (
              <div key={iso} className={`rounded-xl p-2 min-h-[80px] transition-colors ${isToday ? 'bg-accent/10 border border-accent/30' : 'bg-black/5 border border-transparent'}`}>
                <div className="text-center mb-1.5">
                  <div className={`text-[10px] font-medium uppercase ${isToday ? 'text-accent' : 'text-dim'}`}>{d.toLocaleDateString('en-US', { weekday: 'short' })}</div>
                  <div className={`text-sm font-semibold ${isToday ? 'text-accent' : 'text-text'}`}>{d.getDate()}</div>
                </div>
                {items.map(item => (
                  <div key={item.id} onClick={() => setEditingCard(item.id)}
                    className="text-[10px] rounded px-1.5 py-1 mb-1 cursor-pointer truncate hover:opacity-80"
                    style={{ backgroundColor: (PLATFORM_COLORS[item.platform] || '#6B7280') + '22', color: PLATFORM_COLORS[item.platform] || '#6B7280' }}>
                    {item.title}
                  </div>
                ))}
                {items.length === 0 && <p className="text-[9px] text-dim/40 text-center mt-2">‚Äî</p>}
              </div>
            );
          })}
        </div>
        <p className="text-[10px] text-dim mt-2 text-center">Set a publish date on any content card to see it here.</p>
      </div>

      {/* ‚îÄ‚îÄ Content Pipeline ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-semibold">üöÄ Content Pipeline</h3>
          <button onClick={() => setAddingIdea(true)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ New Idea</button>
        </div>

        {addingIdea && (
          <div className="flex gap-2 mb-4 fade-in">
            <input value={newIdea.title} onChange={e => setNewIdea(p => ({ ...p, title: e.target.value }))} placeholder="Content idea..."
              className="flex-1 bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
              onKeyDown={e => { if (e.key === 'Enter') addPipelineItem(); if (e.key === 'Escape') setAddingIdea(false); }} autoFocus />
            <select value={newIdea.platform} onChange={e => setNewIdea(p => ({ ...p, platform: e.target.value }))}
              className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
              <option>Twitter</option><option>TikTok</option><option>Both</option><option>YouTube</option><option>Instagram</option>
            </select>
            <button onClick={addPipelineItem} className="px-3 py-1.5 bg-accent text-white rounded-lg text-xs">Add</button>
            <button onClick={() => setAddingIdea(false)} className="text-dim hover:text-text text-xs px-1">‚úï</button>
          </div>
        )}

        {/* Kanban columns */}
        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-2">
          {PIPELINE_STAGES.map(stage => {
            const items = data.contentPipeline.filter(c => c.status === stage.key);
            return (
              <div key={stage.key} className="bg-black/5 rounded-xl p-2 min-h-[120px]">
                <div className="flex items-center justify-between mb-2 px-1">
                  <span className="text-xs font-medium text-dim">{stage.label}</span>
                  <span className="text-[10px] bg-black/10 text-dim px-1.5 py-0.5 rounded-full">{items.length}</span>
                </div>
                <div className="space-y-1.5">
                  {items.map(item => (
                    <button key={item.id} onClick={() => setEditingCard(item.id)}
                      className="w-full text-left bg-card border border-border/50 rounded-lg p-2 hover:border-accent/40 transition-colors">
                      <p className="text-xs font-medium truncate mb-1">{item.title}</p>
                      <span className="text-[10px] px-1.5 py-0.5 rounded-full" style={{ backgroundColor: (PLATFORM_COLORS[item.platform] || '#6B7280') + '22', color: PLATFORM_COLORS[item.platform] || '#6B7280' }}>
                        {item.platform}
                      </span>
                      {item.hook && <p className="text-[10px] text-dim mt-1 truncate">{item.hook}</p>}
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      </div>

      {/* Edit card modal */}
      <Modal open={!!editCard} onClose={() => setEditingCard(null)} title="Edit Content" wide>
        {editCard && (
          <div className="space-y-3">
            <div>
              <label className="text-xs text-dim block mb-1">Title</label>
              <input value={editCard.title} onChange={e => updatePipelineItem(editCard.id, { title: e.target.value })}
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50" />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-dim block mb-1">Platform</label>
                <select value={editCard.platform} onChange={e => updatePipelineItem(editCard.id, { platform: e.target.value })}
                  className="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-text outline-none">
                  <option>Twitter</option><option>TikTok</option><option>Both</option><option>YouTube</option><option>Instagram</option>
                </select>
              </div>
              <div>
                <label className="text-xs text-dim block mb-1">Status</label>
                <select value={editCard.status} onChange={e => updatePipelineItem(editCard.id, { status: e.target.value })}
                  className="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-text outline-none">
                  {PIPELINE_STAGES.map(s => <option key={s.key} value={s.key}>{s.label}</option>)}
                </select>
              </div>
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Hook</label>
              <input value={editCard.hook || ''} onChange={e => updatePipelineItem(editCard.id, { hook: e.target.value })}
                placeholder="Opening hook line..."
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50" />
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Script</label>
              <textarea value={editCard.script || ''} onChange={e => updatePipelineItem(editCard.id, { script: e.target.value })}
                placeholder="Write your script..."
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50 resize-none" rows={5} />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-dim block mb-1">Publish Date</label>
                <input type="date" value={editCard.publishDate || ''} onChange={e => updatePipelineItem(editCard.id, { publishDate: e.target.value })}
                  className="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-text outline-none" />
              </div>
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Performance Notes</label>
              <textarea value={editCard.performanceNotes || ''} onChange={e => updatePipelineItem(editCard.id, { performanceNotes: e.target.value })}
                placeholder="After publishing ‚Äî how did it perform?"
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50 resize-none" rows={2} />
            </div>
            <div className="flex justify-end pt-2 border-t border-border">
              <button onClick={() => deletePipelineItem(editCard.id)} className="text-xs px-3 py-1.5 text-red-400 hover:bg-red-400/10 rounded-lg transition-colors">Delete</button>
            </div>
          </div>
        )}
      </Modal>

      {/* ‚îÄ‚îÄ Content Potential Suggestions ‚îÄ‚îÄ */}
      {suggestions.length > 0 && (
        <div className="bg-card border border-accent/20 rounded-xl p-4">
          <h3 className="text-sm font-semibold flex items-center gap-2 mb-3">üí° Content Suggestions <span className="text-xs text-dim font-normal">from Learning Center</span></h3>
          <div className="space-y-2">
            {suggestions.map(s => (
              <div key={s.id} className="flex items-center gap-3 py-1.5 px-2 rounded-lg bg-black/5">
                <span className="text-sm flex-1 truncate">{s.title}</span>
                <span className="text-[10px] text-dim">{s.domain}</span>
                <button onClick={() => createFromSuggestion(s)} className="text-xs px-2 py-1 rounded bg-accent/20 text-accent hover:bg-accent/30 transition-colors whitespace-nowrap">
                  + Create content
                </button>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* ‚îÄ‚îÄ References & Inspiration ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-semibold">üìå References & Inspiration</h3>
          <button onClick={() => setAddingRef(true)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add</button>
        </div>

        {addingRef && (
          <div className="flex gap-2 mb-4 fade-in flex-wrap">
            <input value={newRef.title} onChange={e => setNewRef(p => ({ ...p, title: e.target.value }))} placeholder="Reference title..."
              className="flex-1 min-w-[200px] bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
              onKeyDown={e => { if (e.key === 'Enter') addRef(); if (e.key === 'Escape') setAddingRef(false); }} autoFocus />
            <select value={newRef.platform} onChange={e => setNewRef(p => ({ ...p, platform: e.target.value }))}
              className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
              <option>Twitter</option><option>TikTok</option><option>Both</option><option>YouTube</option><option>Instagram</option>
            </select>
            <select value={newRef.type} onChange={e => setNewRef(p => ({ ...p, type: e.target.value }))}
              className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
              <option>Influencer</option><option>Format Idea</option><option>Mood Board</option><option>Article</option><option>Video</option>
            </select>
            <button onClick={addRef} className="px-3 py-1.5 bg-accent text-white rounded-lg text-xs">Add</button>
            <button onClick={() => setAddingRef(false)} className="text-dim hover:text-text text-xs px-1">‚úï</button>
          </div>
        )}

        <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3">
          {data.references.map(ref => (
            <button key={ref.id} onClick={() => setEditingRef(ref.id)}
              className="text-left bg-black/5 border border-border/50 rounded-xl overflow-hidden hover:border-accent/40 transition-colors group">
              <div className="h-16 w-full" style={{ background: `linear-gradient(135deg, ${ref.color || '#8B5CF6'}44, ${ref.color || '#8B5CF6'}11)` }} />
              <div className="p-3">
                <p className="text-sm font-medium truncate mb-1.5">{ref.title}</p>
                <div className="flex gap-1 flex-wrap">
                  <span className="text-[10px] px-1.5 py-0.5 rounded-full" style={{ backgroundColor: (PLATFORM_COLORS[ref.platform] || '#6B7280') + '22', color: PLATFORM_COLORS[ref.platform] || '#6B7280' }}>
                    {ref.platform}
                  </span>
                  <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-black/10 text-dim">{ref.type}</span>
                </div>
              </div>
            </button>
          ))}
        </div>
      </div>

      {/* Edit reference modal */}
      <Modal open={!!editRefCard} onClose={() => setEditingRef(null)} title="Edit Reference">
        {editRefCard && (
          <div className="space-y-3">
            <div>
              <label className="text-xs text-dim block mb-1">Title</label>
              <input value={editRefCard.title} onChange={e => updateRef(editRefCard.id, { title: e.target.value })}
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50" />
            </div>
            <div className="grid grid-cols-2 gap-3">
              <div>
                <label className="text-xs text-dim block mb-1">Platform</label>
                <select value={editRefCard.platform} onChange={e => updateRef(editRefCard.id, { platform: e.target.value })}
                  className="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-text outline-none">
                  <option>Twitter</option><option>TikTok</option><option>Both</option><option>YouTube</option><option>Instagram</option>
                </select>
              </div>
              <div>
                <label className="text-xs text-dim block mb-1">Type</label>
                <select value={editRefCard.type} onChange={e => updateRef(editRefCard.id, { type: e.target.value })}
                  className="w-full bg-bg border border-border rounded-lg px-3 py-2 text-sm text-text outline-none">
                  <option>Influencer</option><option>Format Idea</option><option>Mood Board</option><option>Article</option><option>Video</option>
                </select>
              </div>
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Link</label>
              <input value={editRefCard.link || ''} onChange={e => updateRef(editRefCard.id, { link: e.target.value })}
                placeholder="https://..."
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50" />
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Notes</label>
              <textarea value={editRefCard.notes || ''} onChange={e => updateRef(editRefCard.id, { notes: e.target.value })}
                placeholder="What makes this inspiring?"
                className="w-full bg-black/5 border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50 resize-none" rows={3} />
            </div>
            <div className="flex justify-end pt-2 border-t border-border">
              <button onClick={() => deleteRef(editRefCard.id)} className="text-xs px-3 py-1.5 text-red-400 hover:bg-red-400/10 rounded-lg transition-colors">Delete</button>
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Rich Text Editor (Notion-style) ‚îÄ‚îÄ‚îÄ
function RichEditor({ value, onChange, placeholder = 'Start writing...' }) {
  const editorRef = useRef(null);
  const isInitial = useRef(true);

  useEffect(() => {
    if (isInitial.current && editorRef.current) {
      editorRef.current.innerHTML = value || '';
      isInitial.current = false;
    }
  }, []);

  const exec = (cmd, val = null) => {
    document.execCommand(cmd, false, val);
    editorRef.current?.focus();
    handleInput();
  };

  const handleInput = () => {
    if (editorRef.current) onChange(editorRef.current.innerHTML);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Tab') {
      e.preventDefault();
      exec('insertText', '    ');
    }
  };

  const ToolBtn = ({ cmd, icon, title, val }) => (
    <button onMouseDown={e => { e.preventDefault(); exec(cmd, val); }} title={title}
      className="w-7 h-7 rounded flex items-center justify-center text-xs text-dim hover:text-text hover:bg-black/10 transition-colors">
      {icon}
    </button>
  );

  return (
    <div className="border border-border rounded-lg overflow-hidden">
      {/* Toolbar */}
      <div className="flex items-center gap-0.5 px-2 py-1.5 bg-black/5 border-b border-border flex-wrap">
        <ToolBtn cmd="bold" icon={<span className="font-bold">B</span>} title="Bold (Ctrl+B)" />
        <ToolBtn cmd="italic" icon={<span className="italic">I</span>} title="Italic (Ctrl+I)" />
        <ToolBtn cmd="underline" icon={<span className="underline">U</span>} title="Underline (Ctrl+U)" />
        <div className="w-px h-4 bg-border mx-1" />
        <ToolBtn cmd="formatBlock" val="h2" icon="H1" title="Heading" />
        <ToolBtn cmd="formatBlock" val="h3" icon="H2" title="Subheading" />
        <ToolBtn cmd="formatBlock" val="p" icon="¬∂" title="Paragraph" />
        <div className="w-px h-4 bg-border mx-1" />
        <ToolBtn cmd="insertUnorderedList" icon="‚Ä¢" title="Bullet list" />
        <ToolBtn cmd="insertOrderedList" icon="1." title="Numbered list" />
        <div className="w-px h-4 bg-border mx-1" />
        <ToolBtn cmd="strikeThrough" icon={<span className="line-through">S</span>} title="Strikethrough" />
      </div>
      {/* Editor */}
      <div ref={editorRef} contentEditable suppressContentEditableWarning
        onInput={handleInput} onKeyDown={handleKeyDown}
        data-placeholder={placeholder}
        className="px-3 py-2 min-h-[120px] max-h-[400px] overflow-y-auto text-sm text-text outline-none rich-editor"
        style={{ lineHeight: 1.7 }}
      />
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Delete Confirmation ‚îÄ‚îÄ‚îÄ
function ConfirmModal({ open, onClose, onConfirm, title, message }) {
  if (!open) return null;
  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center px-4" onClick={onClose}>
      <div className="bg-card border border-border rounded-xl p-5 w-full max-w-sm fade-in" onClick={e => e.stopPropagation()}>
        <div className="flex items-center gap-3 mb-3">
          <div className="w-10 h-10 rounded-full bg-red-500/15 flex items-center justify-center text-lg">‚ö†Ô∏è</div>
          <h3 className="font-semibold">{title}</h3>
        </div>
        <p className="text-sm text-dim mb-4">{message}</p>
        <div className="flex gap-2 justify-end">
          <button onClick={onClose} className="px-4 py-2 rounded-lg bg-black/5 hover:bg-black/10 text-sm text-text transition-colors">Cancel</button>
          <button onClick={() => { onConfirm(); onClose(); }} className="px-4 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white text-sm transition-colors">Delete</button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Sticky Notes Sidebar ‚îÄ‚îÄ‚îÄ
function StickyNotes({ domain, color }) {
  const { data, updateData } = useData();
  const [newNote, setNewNote] = useState('');
  const notes = (data.stickyNotes || {})[domain] || [];

  const addNote = () => {
    if (!newNote.trim()) return;
    const note = { id: uid(), text: newNote.trim(), color, createdAt: todayISO() };
    updateData('stickyNotes', prev => ({ ...prev, [domain]: [note, ...(prev?.[domain] || [])] }));
    setNewNote('');
  };

  const deleteNote = (noteId) => {
    updateData('stickyNotes', prev => ({ ...prev, [domain]: (prev?.[domain] || []).filter(n => n.id !== noteId) }));
  };

  const updateNote = (noteId, text) => {
    updateData('stickyNotes', prev => ({ ...prev, [domain]: (prev?.[domain] || []).map(n => n.id === noteId ? { ...n, text } : n) }));
  };

  const STICKY_COLORS = ['#8B5CF6', '#F59E0B', '#EC4899', '#10B981', '#3B82F6', '#EF4444'];

  return (
    <div>
      <div className="flex items-center justify-between mb-2">
        <h4 className="text-xs font-semibold text-dim uppercase tracking-wider">üìå Quick Notes</h4>
      </div>
      {/* Add note input */}
      <div className="flex gap-2 mb-3">
        <input value={newNote} onChange={e => setNewNote(e.target.value)} placeholder="Jot something down..."
          onKeyDown={e => { if (e.key === 'Enter') addNote(); }}
          className="flex-1 bg-black/5 border border-border rounded-lg px-3 py-2.5 text-sm text-text outline-none focus:border-accent/50 placeholder-dim/50" />
        <button onClick={addNote} className="w-10 h-10 rounded-lg bg-accent hover:bg-accent-hover text-white flex items-center justify-center text-lg font-bold flex-shrink-0">+</button>
      </div>
      {/* Notes list */}
      <div className="space-y-2 max-h-[500px] overflow-y-auto pr-1">
        {notes.length === 0 && <p className="text-[10px] text-dim/50 text-center py-4">Quick thoughts go here. No pressure, just jot.</p>}
        {notes.map(note => (
          <div key={note.id} className="group relative rounded-lg p-2.5 transition-all hover:ring-1 hover:ring-black/10"
            style={{ backgroundColor: (note.color || color) + '12', borderLeft: `2px solid ${note.color || color}44` }}>
            <textarea value={note.text} onChange={e => updateNote(note.id, e.target.value)}
              className="w-full bg-transparent text-xs text-text outline-none resize-none leading-relaxed"
              rows={Math.max(1, Math.ceil(note.text.length / 30))} />
            <div className="flex items-center justify-between mt-1">
              <span className="text-[9px] text-dim/50">{note.createdAt}</span>
              <button onClick={() => deleteNote(note.id)}
                className="text-[10px] text-dim/40 hover:text-red-400 opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Board 4: Learning Center ‚îÄ‚îÄ‚îÄ
function LearningCenter() {
  const { data, updateData, settings, updateSettings, getAreaColor } = useData();
  const [expandedEntry, setExpandedEntry] = useState(null);
  const [collapsedDomains, setCollapsedDomains] = useState({});
  const [addingEntry, setAddingEntry] = useState(null);
  const [newEntry, setNewEntry] = useState({ title: '', takeaways: '', source: 'Article', sourceName: '' });
  const [addingDomain, setAddingDomain] = useState(false);
  const [newDomainName, setNewDomainName] = useState('');
  const [editingDomainIdx, setEditingDomainIdx] = useState(null);
  const [confirmDelete, setConfirmDelete] = useState(null);

  const toggleDomain = (d) => setCollapsedDomains(prev => ({ ...prev, [d]: !prev[d] }));

  const domainColors = {
    Crypto: '#8B5CF6', Marketing: '#F97316', 'AI & Tech': '#F59E0B',
    Books: '#3B82F6', 'Í≤ΩÏ†ú/ÏãúÏÇ¨': '#10B981', 'Personal Growth': '#EC4899',
  };
  const getDomainColor = (d) => domainColors[d] || getAreaColor(d) || '#6B7280';

  const updateEntry = (id, changes) => {
    updateData('learnings', prev => prev.map(l => l.id === id ? { ...l, ...changes } : l));
  };
  const deleteEntry = (id) => {
    updateData('learnings', prev => prev.filter(l => l.id !== id));
    setExpandedEntry(null);
  };
  const handleAddEntry = (domain) => {
    if (!newEntry.title.trim()) return;
    const entry = {
      id: uid(), title: newEntry.title.trim(), domain,
      source: newEntry.source, sourceName: newEntry.sourceName,
      takeaways: newEntry.takeaways, contentPotential: false,
      fromTask: null, date: todayISO(),
    };
    updateData('learnings', prev => [entry, ...prev]);
    setNewEntry({ title: '', takeaways: '', source: 'Article', sourceName: '' });
    setAddingEntry(null);
  };
  const addDomain = () => {
    if (!newDomainName.trim()) return;
    updateSettings('learningDomains', [...settings.learningDomains, newDomainName.trim()]);
    setNewDomainName('');
    setAddingDomain(false);
  };
  const renameDomain = (idx, newName) => {
    const oldName = settings.learningDomains[idx];
    const updated = [...settings.learningDomains];
    updated[idx] = newName;
    updateSettings('learningDomains', updated);
    updateData('learnings', prev => prev.map(l => l.domain === oldName ? { ...l, domain: newName } : l));
    setEditingDomainIdx(null);
  };
  const deleteDomain = (idx) => {
    updateSettings('learningDomains', settings.learningDomains.filter((_, i) => i !== idx));
  };

  const handleConfirmDelete = () => {
    if (!confirmDelete) return;
    if (confirmDelete.type === 'domain') deleteDomain(confirmDelete.idx);
    if (confirmDelete.type === 'entry') deleteEntry(confirmDelete.id);
    setConfirmDelete(null);
  };

  // Group entries by domain
  const grouped = {};
  settings.learningDomains.forEach(d => { grouped[d] = []; });
  (data.learnings || []).forEach(l => {
    if (grouped[l.domain]) grouped[l.domain].push(l);
    else {
      if (!grouped['Other']) grouped['Other'] = [];
      grouped['Other'].push(l);
    }
  });

  return (
    <div className="max-w-6xl mx-auto px-4 py-6 space-y-4">
      <div className="flex items-center justify-between mb-2">
        <h2 className="text-lg font-semibold">üìö Learning Center</h2>
        <div className="flex gap-2">
          {addingDomain ? (
            <div className="flex gap-1 fade-in">
              <input value={newDomainName} onChange={e => setNewDomainName(e.target.value)} placeholder="Domain name..."
                className="bg-transparent border border-border rounded-lg px-3 py-1 text-sm text-text outline-none focus:border-accent/50"
                onKeyDown={e => { if (e.key === 'Enter') addDomain(); if (e.key === 'Escape') setAddingDomain(false); }} autoFocus />
              <button onClick={addDomain} className="px-2 py-1 bg-accent text-white rounded-lg text-xs">Add</button>
              <button onClick={() => setAddingDomain(false)} className="text-dim text-xs px-1">‚úï</button>
            </div>
          ) : (
            <button onClick={() => setAddingDomain(true)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add Domain</button>
          )}
        </div>
      </div>

      {settings.learningDomains.map((domain, di) => {
        const entries = grouped[domain] || [];
        const collapsed = collapsedDomains[domain];
        const color = getDomainColor(domain);
        const stickyCount = ((data.stickyNotes || {})[domain] || []).length;
        return (
          <div key={domain} className="bg-card border border-border rounded-xl overflow-hidden">
            {/* Domain header */}
            <div className="flex items-center gap-2 sm:gap-3 px-3 sm:px-4 py-3 cursor-pointer hover:bg-black/5 transition-colors" onClick={() => toggleDomain(domain)}>
              <span className="text-xs">{collapsed ? '‚ñ∂' : '‚ñº'}</span>
              <div className="w-2.5 h-2.5 rounded-full flex-shrink-0" style={{ backgroundColor: color }} />
              {editingDomainIdx === di ? (
                <input defaultValue={domain} autoFocus
                  onBlur={e => renameDomain(di, e.target.value)}
                  onKeyDown={e => { if (e.key === 'Enter') renameDomain(di, e.target.value); if (e.key === 'Escape') setEditingDomainIdx(null); }}
                  onClick={e => e.stopPropagation()}
                  className="bg-transparent border border-accent/50 rounded px-2 py-1 text-sm text-text outline-none" />
              ) : (
                <span className="font-medium text-sm flex-1 truncate">{domain}</span>
              )}
              <span className="text-[10px] text-dim bg-black/5 px-2 py-0.5 rounded-full hidden sm:inline">{entries.length} notes</span>
              <span className="text-[10px] text-dim bg-black/5 px-2 py-0.5 rounded-full hidden sm:inline">{stickyCount} quick</span>
              <button onClick={e => { e.stopPropagation(); setEditingDomainIdx(di); }} className="w-8 h-8 rounded-lg flex items-center justify-center text-dim hover:text-accent hover:bg-black/5 text-sm">‚úèÔ∏è</button>
              <button onClick={e => { e.stopPropagation(); setConfirmDelete({ type: 'domain', idx: di, name: domain }); }}
                className="w-8 h-8 rounded-lg flex items-center justify-center text-dim hover:text-red-400 hover:bg-black/5 text-sm">‚úï</button>
              <button onClick={e => { e.stopPropagation(); setAddingEntry(domain); }}
                className="w-8 h-8 rounded-lg bg-accent hover:bg-accent-hover text-white flex items-center justify-center text-base font-bold flex-shrink-0">+</button>
            </div>

            {!collapsed && (
              <div className="px-4 pb-4">
                {/* Add entry form */}
                {addingEntry === domain && (
                  <div className="mb-3 p-3 bg-black/5 rounded-lg space-y-2 fade-in">
                    <input value={newEntry.title} onChange={e => setNewEntry(p => ({ ...p, title: e.target.value }))} placeholder="Note title (e.g. 'Gas Fees Deep Dive')"
                      className="w-full bg-transparent border border-border rounded-lg px-3 py-2 text-sm text-text outline-none focus:border-accent/50 font-medium"
                      onKeyDown={e => { if (e.key === 'Enter' && newEntry.title.trim()) handleAddEntry(domain); if (e.key === 'Escape') setAddingEntry(null); }} autoFocus />
                    <div className="flex gap-2 flex-wrap">
                      <select value={newEntry.source} onChange={e => setNewEntry(p => ({ ...p, source: e.target.value }))}
                        className="bg-bg border border-border rounded-lg px-2 py-1 text-xs text-text outline-none">
                        <option>Article</option><option>Video</option><option>Book</option><option>Course</option><option>Podcast</option><option>Hands-on</option><option>Conversation</option>
                      </select>
                      <input value={newEntry.sourceName} onChange={e => setNewEntry(p => ({ ...p, sourceName: e.target.value }))} placeholder="Source name..."
                        className="flex-1 min-w-[120px] bg-transparent border border-border rounded-lg px-3 py-1 text-xs text-text outline-none" />
                      <button onClick={() => handleAddEntry(domain)} className="px-3 py-1 bg-accent text-white rounded-lg text-xs">Create</button>
                      <button onClick={() => setAddingEntry(null)} className="text-dim text-xs px-1">‚úï</button>
                    </div>
                  </div>
                )}

                {/* Split layout: Deep Notes (left) | Sticky Notes (right) */}
                <div className="flex flex-col lg:flex-row gap-4">
                  {/* LEFT ‚Äî Deep notebook cards (wider) */}
                  <div className="flex-1 min-w-0 lg:w-2/3">
                    <h4 className="text-xs font-semibold text-dim uppercase tracking-wider mb-2">üìì Deep Notes</h4>
                    {entries.length === 0 && addingEntry !== domain && (
                      <div className="border border-dashed border-border rounded-lg p-6 text-center text-dim text-xs">
                        No deep notes yet. Click + to add, or complete tasks tagged "{domain}".
                      </div>
                    )}
                    <div className="space-y-2">
                      {entries.map(entry => {
                        const isExpanded = expandedEntry === entry.id;
                        return (
                          <div key={entry.id} className={`rounded-xl overflow-hidden transition-all ${isExpanded ? 'bg-black/[0.04] border border-border/70' : 'bg-black/[0.02] border border-transparent hover:border-border/40'}`}
                            style={{ borderLeftWidth: '3px', borderLeftColor: color }}>
                            <div className="flex items-center gap-2 px-3 sm:px-4 py-3 cursor-pointer" onClick={() => setExpandedEntry(isExpanded ? null : entry.id)}>
                              <span className="text-xs text-dim">{isExpanded ? '‚ñº' : '‚ñ∂'}</span>
                              <span className="text-sm font-medium flex-1 truncate">{entry.title}</span>
                              {entry.contentPotential && <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-accent/20 text-accent hidden sm:inline">‚ú®</span>}
                              {entry.fromTask && <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-blue-500/15 text-blue-400 hidden sm:inline">task</span>}
                              <span className="text-[10px] text-dim hidden sm:inline">{entry.source}</span>
                            </div>
                            {isExpanded && (
                              <div className="px-3 sm:px-4 pb-4 space-y-3 fade-in" onClick={e => e.stopPropagation()}>
                                <input value={entry.title} onChange={e => updateEntry(entry.id, { title: e.target.value })}
                                  className="w-full bg-transparent text-base font-semibold text-text outline-none border-b border-border/50 pb-2 focus:border-accent/50" />
                                <div>
                                  <label className="text-xs text-dim block mb-1.5">Notes</label>
                                  <RichEditor value={entry.takeaways || ''} onChange={v => updateEntry(entry.id, { takeaways: v })} placeholder="Start writing..." />
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 pt-1">
                                  <select value={entry.source || ''} onChange={e => updateEntry(entry.id, { source: e.target.value })}
                                    className="bg-bg border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none">
                                    <option>Article</option><option>Video</option><option>Book</option><option>Course</option><option>Podcast</option><option>Hands-on</option><option>Conversation</option>
                                  </select>
                                  <input value={entry.sourceName || ''} onChange={e => updateEntry(entry.id, { sourceName: e.target.value })}
                                    className="bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50" placeholder="Source name" />
                                </div>
                                <div className="flex flex-wrap items-center justify-between pt-2 border-t border-border/40 gap-2">
                                  <label className="flex items-center gap-2 cursor-pointer">
                                    <button onClick={() => updateEntry(entry.id, { contentPotential: !entry.contentPotential })}
                                      className={`w-4 h-4 rounded border-2 flex items-center justify-center text-[10px] transition-colors ${entry.contentPotential ? 'border-accent bg-accent text-white' : 'border-border'}`}>
                                      {entry.contentPotential && '‚úì'}
                                    </button>
                                    <span className="text-xs text-dim">Content Potential</span>
                                  </label>
                                  <div className="flex items-center gap-2">
                                    {entry.fromTask && <span className="text-[10px] text-dim">üìã {entry.fromTask}</span>}
                                    <span className="text-[10px] text-dim">{entry.date}</span>
                                    <button onClick={() => setConfirmDelete({ type: 'entry', id: entry.id, name: entry.title })}
                                      className="text-xs text-red-400/70 hover:text-red-400 px-2 py-1 rounded">Delete</button>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        );
                      })}
                    </div>
                  </div>

                  {/* RIGHT ‚Äî Sticky notes (narrower) */}
                  <div className="lg:w-1/3 lg:border-l lg:border-border/50 lg:pl-4">
                    <StickyNotes domain={domain} color={color} />
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      })}

      <div className="bg-black/5 border border-border rounded-xl p-3 text-center">
        <p className="text-xs text-dim">üí° Entries with "Content Potential" checked appear as suggestions in Content Hub.</p>
      </div>

      <ConfirmModal
        open={!!confirmDelete}
        onClose={() => setConfirmDelete(null)}
        onConfirm={handleConfirmDelete}
        title={confirmDelete?.type === 'domain' ? 'Delete domain?' : 'Delete entry?'}
        message={confirmDelete?.type === 'domain'
          ? `This will remove "${confirmDelete?.name}" from your domains. Existing entries won't be deleted but will be ungrouped.`
          : `This will permanently delete "${confirmDelete?.name}". This can't be undone.`}
      />
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Board 5: Finance ‚îÄ‚îÄ‚îÄ
const CURRENCY_SYMBOLS = { THB: '‡∏ø', KRW: '‚Ç©', USD: '$' };
const CHART_COLORS = ['#8B5CF6', '#EC4899', '#F59E0B', '#3B82F6', '#10B981', '#F97316', '#EF4444', '#6366F1', '#14B8A6'];

function FinanceBoard() {
  const { data, updateData, settings, updateSettings } = useData();
  const [addingExpense, setAddingExpense] = useState(false);
  const [newExpense, setNewExpense] = useState({ item: '', amount: '', currency: 'THB', category: settings.spendingCategories[0] || 'Food' });
  const [addingFixed, setAddingFixed] = useState(false);
  const [newFixed, setNewFixed] = useState({ name: '', amount: '', currency: 'KRW', type: 'Monthly' });
  const [editingFixedId, setEditingFixedId] = useState(null);
  const [editingExpenseId, setEditingExpenseId] = useState(null);

  // Fixed expenses
  const updateFixed = (id, changes) => updateData('fixedExpenses', prev => prev.map(e => e.id === id ? { ...e, ...changes } : e));
  const deleteFixed = (id) => updateData('fixedExpenses', prev => prev.filter(e => e.id !== id));
  const addFixed = () => {
    if (!newFixed.name.trim() || !newFixed.amount) return;
    updateData('fixedExpenses', prev => [...prev, { id: uid(), name: newFixed.name.trim(), amount: parseFloat(newFixed.amount), currency: newFixed.currency, type: newFixed.type }]);
    setNewFixed({ name: '', amount: '', currency: 'KRW', type: 'Monthly' });
    setAddingFixed(false);
  };

  // Spending log
  const updateExpense = (id, changes) => updateData('expenses', prev => prev.map(e => e.id === id ? { ...e, ...changes } : e));
  const deleteExpense = (id) => updateData('expenses', prev => prev.filter(e => e.id !== id));
  const addExpense = () => {
    if (!newExpense.item.trim() || !newExpense.amount) return;
    updateData('expenses', prev => [{ id: uid(), item: newExpense.item.trim(), amount: parseFloat(newExpense.amount), currency: newExpense.currency, category: newExpense.category, date: todayISO() }, ...prev]);
    setNewExpense({ item: '', amount: '', currency: 'THB', category: settings.spendingCategories[0] || 'Food' });
    setAddingExpense(false);
  };

  // Spending by category ‚Äî aggregate current month
  const now = new Date();
  const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
  const monthExpenses = (data.expenses || []).filter(e => (e.date || '').startsWith(currentMonth));
  const categoryTotals = {};
  monthExpenses.forEach(e => {
    const cat = e.category || 'Other';
    categoryTotals[cat] = (categoryTotals[cat] || 0) + (e.amount || 0);
  });
  const totalSpent = Object.values(categoryTotals).reduce((a, b) => a + b, 0);
  const categoryList = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]);

  // Simple donut chart with SVG (no Recharts dependency needed)
  const DonutChart = ({ data: chartData, total }) => {
    if (chartData.length === 0) {
      return (
        <div className="w-48 h-48 mx-auto flex items-center justify-center">
          <div className="w-40 h-40 rounded-full border-4 border-border flex items-center justify-center">
            <span className="text-dim text-xs">No data</span>
          </div>
        </div>
      );
    }
    let cumulative = 0;
    const radius = 70;
    const circumference = 2 * Math.PI * radius;
    return (
      <div className="relative w-48 h-48 mx-auto">
        <svg viewBox="0 0 200 200" className="w-full h-full -rotate-90">
          {chartData.map(([cat, amount], i) => {
            const pct = amount / total;
            const offset = cumulative * circumference;
            cumulative += pct;
            return (
              <circle key={cat} cx="100" cy="100" r={radius} fill="none"
                stroke={CHART_COLORS[i % CHART_COLORS.length]} strokeWidth="24"
                strokeDasharray={`${pct * circumference} ${circumference}`}
                strokeDashoffset={-offset}
                className="transition-all duration-500" />
            );
          })}
        </svg>
        <div className="absolute inset-0 flex flex-col items-center justify-center">
          <span className="text-lg font-bold">‡∏ø{Math.round(totalSpent).toLocaleString()}</span>
          <span className="text-[10px] text-dim">This month</span>
        </div>
      </div>
    );
  };

  const formatAmount = (amount, currency) => {
    const sym = CURRENCY_SYMBOLS[currency] || currency;
    return sym + Number(amount).toLocaleString();
  };

  return (
    <div className="max-w-4xl mx-auto px-4 py-6 space-y-6">
      {/* ‚îÄ‚îÄ Section 1: Fixed Expenses ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-semibold">1Ô∏è‚É£ Monthly Fixed Expenses</h3>
          <button onClick={() => setAddingFixed(true)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add</button>
        </div>

        <div className="overflow-x-auto">
          <table className="w-full text-sm">
            <thead>
              <tr className="text-dim text-xs border-b border-border">
                <th className="text-left py-2 px-2 font-medium">Item</th>
                <th className="text-right py-2 px-2 font-medium">Amount</th>
                <th className="text-center py-2 px-2 font-medium">Currency</th>
                <th className="text-center py-2 px-2 font-medium">Type</th>
                <th className="w-8"></th>
              </tr>
            </thead>
            <tbody>
              {(data.fixedExpenses || []).map(exp => (
                <tr key={exp.id} className="border-b border-border/50 group hover:bg-black/5">
                  <td className="py-2 px-2">
                    {editingFixedId === exp.id ? (
                      <input value={exp.name} onChange={e => updateFixed(exp.id, { name: e.target.value })}
                        onBlur={() => setEditingFixedId(null)}
                        className="bg-transparent border border-accent/50 rounded px-2 py-0.5 text-sm text-text outline-none w-full" autoFocus />
                    ) : (
                      <span className="cursor-pointer hover:text-accent" onClick={() => setEditingFixedId(exp.id)}>{exp.name}</span>
                    )}
                  </td>
                  <td className="py-2 px-2 text-right font-mono">
                    <input type="number" value={exp.amount} onChange={e => updateFixed(exp.id, { amount: parseFloat(e.target.value) || 0 })}
                      className="bg-transparent text-right text-sm text-text outline-none w-24 hover:bg-black/5 rounded px-1" />
                  </td>
                  <td className="py-2 px-2 text-center">
                    <select value={exp.currency} onChange={e => updateFixed(exp.id, { currency: e.target.value })}
                      className="bg-transparent text-xs text-dim outline-none cursor-pointer text-center">
                      <option>KRW</option><option>USD</option><option>THB</option>
                    </select>
                  </td>
                  <td className="py-2 px-2 text-center">
                    <select value={exp.type} onChange={e => updateFixed(exp.id, { type: e.target.value })}
                      className="bg-transparent text-xs text-dim outline-none cursor-pointer text-center">
                      <option>Monthly</option><option>Subscription</option><option>ÎåÄÏ∂ú</option>
                    </select>
                  </td>
                  <td className="py-2 px-2 text-center">
                    <button onClick={() => deleteFixed(exp.id)} className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        {addingFixed && (
          <div className="flex gap-2 mt-3 fade-in flex-wrap">
            <input value={newFixed.name} onChange={e => setNewFixed(p => ({ ...p, name: e.target.value }))} placeholder="Item name..."
              className="flex-1 min-w-[140px] bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
              onKeyDown={e => { if (e.key === 'Enter') addFixed(); if (e.key === 'Escape') setAddingFixed(false); }} autoFocus />
            <input type="number" value={newFixed.amount} onChange={e => setNewFixed(p => ({ ...p, amount: e.target.value }))} placeholder="Amount"
              className="w-24 bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
            <select value={newFixed.currency} onChange={e => setNewFixed(p => ({ ...p, currency: e.target.value }))}
              className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
              <option>KRW</option><option>USD</option><option>THB</option>
            </select>
            <select value={newFixed.type} onChange={e => setNewFixed(p => ({ ...p, type: e.target.value }))}
              className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
              <option>Monthly</option><option>Subscription</option><option>ÎåÄÏ∂ú</option>
            </select>
            <button onClick={addFixed} className="px-3 py-1.5 bg-accent text-white rounded-lg text-xs">Add</button>
            <button onClick={() => setAddingFixed(false)} className="text-dim text-xs px-1">‚úï</button>
          </div>
        )}
      </div>

      {/* ‚îÄ‚îÄ Section 2: Spending by Category ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <h3 className="font-semibold mb-4">2Ô∏è‚É£ Spending by Category <span className="text-dim font-normal text-sm ml-2">This month</span></h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          {/* Donut chart */}
          <DonutChart data={categoryList} total={totalSpent} />
          {/* Breakdown */}
          <div className="space-y-2 flex flex-col justify-center">
            {categoryList.length === 0 && <p className="text-dim text-sm text-center">No spending logged this month.</p>}
            {categoryList.map(([cat, amount], i) => {
              const pct = totalSpent > 0 ? Math.round((amount / totalSpent) * 100) : 0;
              return (
                <div key={cat} className="flex items-center gap-3">
                  <div className="w-3 h-3 rounded-full flex-shrink-0" style={{ backgroundColor: CHART_COLORS[i % CHART_COLORS.length] }} />
                  <span className="text-sm flex-1">{cat}</span>
                  <span className="text-sm font-mono">‡∏ø{Math.round(amount).toLocaleString()}</span>
                  <span className="text-xs text-dim w-10 text-right">{pct}%</span>
                </div>
              );
            })}
          </div>
        </div>
      </div>

      {/* ‚îÄ‚îÄ Section 3: Spending Log ‚îÄ‚îÄ */}
      <div className="bg-card border border-border rounded-xl p-4">
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-semibold">üí≥ Spending Log</h3>
          <button onClick={() => setAddingExpense(true)} className="text-xs px-2.5 py-1 rounded-lg bg-accent hover:bg-accent-hover text-white">+ Add</button>
        </div>

        {addingExpense && (
          <div className="bg-black/5 rounded-lg p-3 mb-4 fade-in">
            <div className="flex gap-2 flex-wrap">
              <input value={newExpense.item} onChange={e => setNewExpense(p => ({ ...p, item: e.target.value }))} placeholder="What did you buy?"
                className="flex-1 min-w-[160px] bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none focus:border-accent/50"
                onKeyDown={e => { if (e.key === 'Enter') addExpense(); if (e.key === 'Escape') setAddingExpense(false); }} autoFocus />
              <input type="number" value={newExpense.amount} onChange={e => setNewExpense(p => ({ ...p, amount: e.target.value }))} placeholder="Amount"
                className="w-24 bg-transparent border border-border rounded-lg px-3 py-1.5 text-sm text-text outline-none" />
              <select value={newExpense.currency} onChange={e => setNewExpense(p => ({ ...p, currency: e.target.value }))}
                className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
                <option>THB</option><option>KRW</option><option>USD</option>
              </select>
              <select value={newExpense.category} onChange={e => setNewExpense(p => ({ ...p, category: e.target.value }))}
                className="bg-bg border border-border rounded-lg px-2 py-1.5 text-xs text-text outline-none">
                {settings.spendingCategories.map(c => <option key={c}>{c}</option>)}
              </select>
              <button onClick={addExpense} className="px-3 py-1.5 bg-accent text-white rounded-lg text-xs">Add</button>
              <button onClick={() => setAddingExpense(false)} className="text-dim text-xs px-1">‚úï</button>
            </div>
          </div>
        )}

        {(data.expenses || []).length === 0 && (
          <p className="text-dim text-sm text-center py-4">No expenses logged. Click "+ Add" to start tracking.</p>
        )}

        <div className="space-y-1">
          {(data.expenses || []).map(exp => (
            <div key={exp.id} className="flex items-center gap-3 py-2 px-2 rounded-lg group hover:bg-black/5 transition-colors">
              {editingExpenseId === exp.id ? (
                <React.Fragment>
                  <input value={exp.item} onChange={e => updateExpense(exp.id, { item: e.target.value })}
                    className="flex-1 bg-transparent border border-accent/50 rounded px-2 py-0.5 text-sm text-text outline-none" autoFocus />
                  <input type="number" value={exp.amount} onChange={e => updateExpense(exp.id, { amount: parseFloat(e.target.value) || 0 })}
                    className="w-20 bg-transparent border border-accent/50 rounded px-2 py-0.5 text-sm text-text outline-none text-right" />
                  <select value={exp.currency} onChange={e => updateExpense(exp.id, { currency: e.target.value })}
                    className="bg-bg border border-border rounded px-1 py-0.5 text-xs text-text outline-none">
                    <option>THB</option><option>KRW</option><option>USD</option>
                  </select>
                  <select value={exp.category} onChange={e => updateExpense(exp.id, { category: e.target.value })}
                    className="bg-bg border border-border rounded px-1 py-0.5 text-xs text-text outline-none">
                    {settings.spendingCategories.map(c => <option key={c}>{c}</option>)}
                  </select>
                  <button onClick={() => setEditingExpenseId(null)} className="text-xs text-accent">‚úì</button>
                </React.Fragment>
              ) : (
                <React.Fragment>
                  <span className="text-sm flex-1 cursor-pointer hover:text-accent" onClick={() => setEditingExpenseId(exp.id)}>{exp.item}</span>
                  <span className="text-xs px-2 py-0.5 rounded-full bg-black/5 text-dim">{exp.category}</span>
                  <span className="text-sm font-mono" style={{ color: '#37352F' }}>{formatAmount(exp.amount, exp.currency)}</span>
                  <span className="text-[10px] text-dim">{exp.date}</span>
                </React.Fragment>
              )}
              <button onClick={() => deleteExpense(exp.id)} className="text-dim hover:text-red-400 text-xs opacity-0 group-hover:opacity-100 transition-opacity">‚úï</button>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Web Clipper: classify incoming share ‚îÄ‚îÄ‚îÄ
function classifyClip(title, text, url, clipRules) {
  const combined = `${title || ''} ${text || ''} ${url || ''}`.toLowerCase();
  for (const rule of (clipRules || [])) {
    if (combined.includes(rule.keyword.toLowerCase())) {
      return rule.domain;
    }
  }
  return null; // no match ‚Üí user picks manually
}

// ‚îÄ‚îÄ‚îÄ Web Clipper: Review Modal ‚îÄ‚îÄ‚îÄ
// Detect platform from URL
function detectPlatform(url) {
  if (!url) return null;
  const u = url.toLowerCase();
  if (u.includes('twitter.com') || u.includes('x.com')) return 'Twitter';
  if (u.includes('tiktok.com')) return 'TikTok';
  if (u.includes('youtube.com') || u.includes('youtu.be')) return 'YouTube';
  if (u.includes('instagram.com')) return 'Instagram';
  return null;
}

function ClipReviewModal({ clip, onSave, onDiscard }) {
  const { settings } = useData();
  const detectedPlatform = detectPlatform(clip.url);
  const isContentSource = !!detectedPlatform;

  // Destination: 'learning' or 'content'
  const [dest, setDest] = useState(isContentSource ? 'content' : 'learning');
  const [title, setTitle] = useState(clip.title || '');
  const [notes, setNotes] = useState(clip.text || '');

  // Learning-specific
  const [domain, setDomain] = useState(clip.suggestedDomain || settings.learningDomains[0] || '');
  const [source, setSource] = useState(
    detectedPlatform === 'Twitter' ? 'Tweet' :
    detectedPlatform === 'TikTok' ? 'TikTok' :
    detectedPlatform === 'YouTube' ? 'Video' :
    clip.url ? 'Article' : 'Hands-on'
  );

  // Content-specific
  const [platform, setPlatform] = useState(detectedPlatform || 'Twitter');
  const [refType, setRefType] = useState('Influencer');

  return (
    <div className="fixed inset-0 bg-black/60 z-50 flex items-end sm:items-center justify-center px-0 sm:px-4" onClick={onDiscard}>
      <div className="w-full sm:max-w-lg bg-card sm:rounded-2xl rounded-t-2xl p-5 sm:p-6 space-y-4 fade-in max-h-[85vh] overflow-y-auto" onClick={e => e.stopPropagation()}>
        {/* Header */}
        <div className="flex items-center gap-3 mb-1">
          <div className="w-10 h-10 rounded-xl bg-accent/15 flex items-center justify-center text-lg">üìé</div>
          <div>
            <h3 className="font-semibold">Incoming Clip</h3>
            <p className="text-xs text-dim">Choose where to save it</p>
          </div>
        </div>

        {/* Destination toggle */}
        <div className="flex rounded-xl bg-black/5 p-1 gap-1">
          <button onClick={() => setDest('learning')}
            className={`flex-1 py-2.5 rounded-lg text-sm font-medium transition-colors ${dest === 'learning' ? 'bg-card text-text shadow-sm' : 'text-dim'}`}>
            üìö Learning
          </button>
          <button onClick={() => setDest('content')}
            className={`flex-1 py-2.5 rounded-lg text-sm font-medium transition-colors ${dest === 'content' ? 'bg-card text-text shadow-sm' : 'text-dim'}`}>
            ‚ú® Content Inspo
          </button>
        </div>

        {/* Title */}
        <div>
          <label className="text-xs text-dim block mb-1">Title</label>
          <input value={title} onChange={e => setTitle(e.target.value)}
            className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none focus:border-accent/50" />
        </div>

        {/* URL preview */}
        {clip.url && (
          <div className="bg-black/5 rounded-lg px-3 py-2 flex items-center gap-2">
            <span className="text-xs text-dim">üîó</span>
            <span className="text-xs text-accent truncate flex-1">{clip.url}</span>
          </div>
        )}

        {/* ‚îÄ‚îÄ‚îÄ Learning-specific fields ‚îÄ‚îÄ‚îÄ */}
        {dest === 'learning' && (
          <>
            <div>
              <label className="text-xs text-dim block mb-1">Domain</label>
              <select value={domain} onChange={e => setDomain(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none">
                {settings.learningDomains.map(d => <option key={d} value={d}>{d}</option>)}
              </select>
              {clip.suggestedDomain && (
                <p className="text-[10px] text-accent mt-1">Auto-classified: "{clip.suggestedDomain}"</p>
              )}
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Notes / Key takeaway</label>
              <textarea value={notes} onChange={e => setNotes(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none focus:border-accent/50 resize-none" rows={3}
                placeholder="What's the insight? What caught your eye?" />
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Source type</label>
              <select value={source} onChange={e => setSource(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none">
                <option>Article</option><option>Video</option><option>Tweet</option><option>TikTok</option><option>Podcast</option><option>Book</option><option>Conversation</option>
              </select>
            </div>
          </>
        )}

        {/* ‚îÄ‚îÄ‚îÄ Content Inspo-specific fields ‚îÄ‚îÄ‚îÄ */}
        {dest === 'content' && (
          <>
            <div>
              <label className="text-xs text-dim block mb-1">Platform</label>
              <select value={platform} onChange={e => setPlatform(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none">
                <option>Twitter</option><option>TikTok</option><option>YouTube</option><option>Instagram</option><option>Both</option>
              </select>
              {detectedPlatform && (
                <p className="text-[10px] text-accent mt-1">Auto-detected: {detectedPlatform}</p>
              )}
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Type</label>
              <select value={refType} onChange={e => setRefType(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none">
                <option>Influencer</option><option>Format Idea</option><option>Hook</option><option>Mood Board</option><option>Viral Example</option><option>Competitor</option>
              </select>
            </div>
            <div>
              <label className="text-xs text-dim block mb-1">Notes</label>
              <textarea value={notes} onChange={e => setNotes(e.target.value)}
                className="w-full bg-bg border border-border rounded-xl px-4 py-3 text-sm text-text outline-none focus:border-accent/50 resize-none" rows={3}
                placeholder="Why is this inspiring? What can you learn from it?" />
            </div>
          </>
        )}

        {/* Action buttons */}
        <div className="flex gap-3 pt-2">
          <button onClick={onDiscard} className="flex-1 py-3 rounded-xl text-sm text-dim bg-black/5 hover:bg-black/10 transition-colors">Discard</button>
          <button onClick={() => onSave({ dest, title, domain, notes, source, url: clip.url, platform, refType })}
            className="flex-1 py-3 rounded-xl bg-accent hover:bg-accent-hover text-white text-sm font-medium transition-colors">
            {dest === 'learning' ? 'Save to Learning' : 'Save to Content'}
          </button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ App ‚îÄ‚îÄ‚îÄ
function App() {
  const [activeBoard, setActiveBoard] = useState('braindump');
  const [settingsOpen, setSettingsOpen] = useState(false);
  const [settingsTab, setSettingsTab] = useState('tags');
  const [pendingClip, setPendingClip] = useState(null);
  const { settings, updateData } = useData();

  // ‚îÄ‚îÄ‚îÄ Detect incoming share (Web Clipper / Share Target) ‚îÄ‚îÄ‚îÄ
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    const sharedTitle = params.get('title') || '';
    const sharedText  = params.get('text') || '';
    const sharedUrl   = params.get('url') || '';

    if (sharedTitle || sharedText || sharedUrl) {
      const suggestedDomain = classifyClip(sharedTitle, sharedText, sharedUrl, settings.clipRules);
      setPendingClip({
        title: sharedTitle || (sharedUrl ? new URL(sharedUrl).hostname : 'Untitled clip'),
        text: sharedText,
        url: sharedUrl,
        suggestedDomain,
      });
      // Clean URL params so refreshing doesn't re-trigger
      window.history.replaceState({}, '', window.location.pathname);
    }
  }, []);

  const handleSaveClip = ({ dest, title, domain, notes, source, url, platform, refType }) => {
    if (dest === 'content') {
      // Save to Content Hub ‚Üí References & Inspiration
      const PLATFORM_COLORS = { Twitter: '#3B82F6', TikTok: '#EC4899', YouTube: '#EF4444', Instagram: '#F97316', Both: '#8B5CF6' };
      const ref = {
        id: uid(), title,
        platform: platform || 'Twitter',
        type: refType || 'Influencer',
        link: url || '',
        notes: notes || '',
        tags: [],
        color: PLATFORM_COLORS[platform] || '#8B5CF6',
      };
      updateData('references', prev => [ref, ...prev]);
      setPendingClip(null);
      setActiveBoard('content');
    } else {
      // Save to Learning Center
      const entry = {
        id: uid(), title, domain,
        source, sourceName: url || '',
        takeaways: notes,
        contentPotential: false,
        fromTask: null, date: todayISO(),
      };
      updateData('learnings', prev => [entry, ...prev]);
      setPendingClip(null);
      setActiveBoard('learning');
    }
  };

  // ‚îÄ‚îÄ‚îÄ Clip from clipboard (iOS workaround) ‚îÄ‚îÄ‚îÄ
  const handleClipFromClipboard = async () => {
    try {
      const text = await navigator.clipboard.readText();
      if (!text || !text.trim()) {
        alert('Nothing in your clipboard. Copy a URL or text first, then tap üìé.');
        return;
      }
      // Try to detect if it's a URL
      const trimmed = text.trim();
      let clipUrl = '';
      let clipTitle = '';
      let clipText = '';
      try {
        const parsed = new URL(trimmed);
        clipUrl = trimmed;
        clipTitle = parsed.hostname.replace('www.', '');
      } catch {
        // Not a URL ‚Äî treat as text
        clipText = trimmed;
        clipTitle = trimmed.slice(0, 60) + (trimmed.length > 60 ? '...' : '');
      }
      const suggestedDomain = classifyClip(clipTitle, clipText, clipUrl, settings.clipRules);
      setPendingClip({
        title: clipTitle,
        text: clipText,
        url: clipUrl,
        suggestedDomain,
      });
    } catch (err) {
      // Clipboard permission denied
      alert('Clipboard access denied. On iOS, make sure you\'re using HTTPS and tap "Paste" when prompted.');
    }
  };

  const openSettings = (tab = 'tags') => {
    setSettingsTab(tab);
    setSettingsOpen(true);
  };

  const renderBoard = () => {
    switch (activeBoard) {
      case 'braindump': return <BrainDump onOpenSettings={openSettings} />;
      case 'command': return <CommandCenter />;
      case 'content': return <ContentHub />;
      case 'learning': return <LearningCenter />;
      case 'finance': return <FinanceBoard />;
      default: return <BrainDump onOpenSettings={openSettings} />;
    }
  };

  return (
    <div className="min-h-screen bg-bg">
      <Header onOpenSettings={() => openSettings('tags')} onClipFromClipboard={handleClipFromClipboard} />
      <NavBar active={activeBoard} onChange={setActiveBoard} />
      <main className="pb-20">
        {renderBoard()}
      </main>
      <SettingsPanel open={settingsOpen} onClose={() => setSettingsOpen(false)} initialTab={settingsTab} />
      {pendingClip && (
        <ClipReviewModal clip={pendingClip} onSave={handleSaveClip} onDiscard={() => setPendingClip(null)} />
      )}
    </div>
  );
}

// ‚îÄ‚îÄ‚îÄ Auth Gate ‚îÄ‚îÄ‚îÄ
// If Supabase is configured, require login. Otherwise, run in local-only mode.
function AuthGate() {
  const { user, loading } = useAuth();

  // Loading spinner
  if (loading) return (
    <div className="min-h-screen bg-bg flex items-center justify-center">
      <div className="text-center">
        <div className="w-12 h-12 mx-auto mb-3 rounded-2xl bg-gradient-to-br from-accent to-purple-400 flex items-center justify-center text-xl">üß†</div>
        <p className="text-dim text-sm">Loading...</p>
      </div>
    </div>
  );

  // Supabase configured but not logged in ‚Üí show login
  if (sb && !user) return <LoginScreen />;

  // Either: no Supabase (local-only mode), or logged in ‚Üí show app
  return <DataProvider><App /></DataProvider>;
}

// ‚îÄ‚îÄ‚îÄ Mount ‚îÄ‚îÄ‚îÄ
ReactDOM.createRoot(document.getElementById('root')).render(
  <AuthProvider><AuthGate /></AuthProvider>
);
</script>
</body>
</html>
